<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>市場予測システム - 確率思考の戦略論ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .content-panel, .auth-card { display: none; }
        .prose { color: #374151; max-width: none; padding: 0.5rem 1rem 1.5rem 1rem; }
        .prose h3 { font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; margin-top: 1.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e5e7eb; }
        .prose strong { font-weight: 700; color: #4f46e5; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-top: 0.75rem; }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tooltip-container { position: relative; display: inline-flex; align-items: center; }
        .tooltip-content { position: absolute; left: 50%; transform: translateX(-50%); bottom: 125%; width: max-content; max-width: 320px; padding: 12px; background-color: #1f2937; color: white; font-size: 0.875rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 20; pointer-events: none; }
        .tooltip-content::after { content: ''; position: absolute; left: 50%; top: 100%; transform: translateX(-50%); border-width: 8px; border-style: solid; border-color: #1f2937 transparent transparent transparent; }
        .tooltip-container:hover .tooltip-content { opacity: 1; visibility: visible; }
        .chart-tooltip { position: absolute; display: none; background: rgba(0, 0, 0, 0.8); color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px; pointer-events: none; white-space: pre-wrap; z-index: 10; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- ===== Authentication Flow Container ===== -->
    <div id="auth-container">
        <div class="flex items-center justify-center min-h-screen">
            <div id="loading-section" class="text-center">
                <div class="loader mx-auto"></div>
                <p class="mt-4 text-gray-600">状態を確認中...</p>
            </div>
            <div id="login-section" class="auth-card max-w-md w-full bg-white p-8 rounded-2xl shadow-lg">
                <h2 id="auth-title" class="text-2xl font-bold text-center text-gray-800">ログイン</h2>
                <p id="auth-subtitle" class="text-gray-600 mt-2 mb-6 text-center">ツールを利用するにはログインが必要です。</p>
                <form id="login-form" class="space-y-4">
                    <div><input type="email" id="email-input" placeholder="メールアドレス" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"></div>
                    <div><input type="password" id="password-input" placeholder="パスワード (6文字以上)" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"></div>
                    <button type="submit" id="auth-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-md">ログイン</button>
                </form>
                <div id="auth-error" class="hidden mt-4 text-sm text-red-600 bg-red-100 p-3 rounded-lg"></div>
                <div id="auth-success" class="hidden mt-4 text-sm text-green-700 bg-green-100 p-3 rounded-lg"></div>
                <p class="mt-6 text-sm text-center text-gray-600">
                    <span id="auth-prompt-text">アカウントをお持ちでないですか？</span>
                    <a href="#" id="toggle-auth-mode" class="font-medium text-blue-600 hover:text-blue-500">新規登録</a>
                </p>
            </div>
        </div>
    </div>
    
    <!-- ===== Application Main Container ===== -->
    <div id="app-container" class="hidden">
        <div class="bg-gray-100 min-h-screen text-gray-800 p-4 sm:p-6 lg:p-8">
            <div class="max-w-screen-xl mx-auto">
                <header class="mb-6 flex justify-between items-center">
                    <div class="text-center lg:text-left">
                        <h1 class="text-3xl lg:text-4xl font-extrabold text-gray-900">市場予測システム</h1>
                        <p class="text-md lg:text-lg text-gray-600 mt-1">確率思考の戦略ツール</p>
                    </div>
                    <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-md">ログアウト</button>
                </header>
                
                <div id="common-inputs-container" class="lg:col-span-4 bg-white p-4 rounded-2xl shadow-md mb-8" style="display: none;">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">分析の基本設定</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-4">
                        <div>
                            <div class="flex items-center mb-1">
                                <label class="block text-sm font-medium text-gray-700">市場の総顧客数</label>
                                <div class="tooltip-container ml-2">
                                    <i data-lucide="help-circle" class="text-gray-400" style="width: 16px; height: 16px;"></i>
                                    <div class="tooltip-content">ビジネスを展開するエリアの潜在的な顧客総数（例：市の人口、ターゲット層の人口）。全ての計算の母数となる最も重要な数値です。</div>
                                </div>
                            </div>
                            <input type="number" id="total-customers-input" value="150000" class="w-full p-2 border border-gray-300 rounded-lg"/>
                        </div>
                        <div>
                            <div class="flex items-center mb-1">
                                <label class="block text-sm font-medium text-gray-700">顧客タイプの仮説 (K値)</label>
                                 <div class="tooltip-container ml-2">
                                    <i data-lucide="help-circle" class="text-gray-400" style="width: 16px; height: 16px;"></i>
                                    <div class="tooltip-content">あなたのビジネスの顧客タイプを仮説として設定します。左側が『ファン集中型』、右側が『大衆利用型』です。</div>
                                </div>
                            </div>
                            <input type="range" id="k-value-input" min="0.1" max="3.0" step="0.05" value="0.5" class="w-full h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer"/>
                            <div class="flex justify-between text-xs text-gray-500 px-1">
                                <span class="font-bold text-red-600">ファン集中型</span>
                                <span class="font-bold text-blue-600">大衆利用型</span>
                            </div>
                            <div id="k-value-display" class="text-center font-bold text-gray-700 text-lg mt-1">0.50</div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <nav class="lg:col-span-1 flex lg:flex-col gap-2">
                        <button data-tab="methodology" class="tab-button flex items-center justify-center text-left sm:justify-start text-sm sm:text-base font-bold py-3 px-4 rounded-lg transition-all duration-300 transform w-full bg-blue-600 text-white shadow-lg scale-105">
                            <i data-lucide="book-open" class="h-5 w-5 mr-2"></i>使い方・分析方法
                        </button>
                        <button data-tab="howToUse" class="tab-button flex items-center justify-center text-left sm:justify-start text-sm sm:text-base font-bold py-3 px-4 rounded-lg transition-all duration-300 transform w-full bg-white text-gray-700 hover:bg-gray-200 hover:scale-105">
                            <i data-lucide="lightbulb" class="h-5 w-5 mr-2"></i>分析結果の活用法
                        </button>
                        <button data-tab="single" class="tab-button flex items-center justify-center text-left sm:justify-start text-sm sm:text-base font-bold py-3 px-4 rounded-lg transition-all duration-300 transform w-full bg-white text-gray-700 hover:bg-gray-200 hover:scale-105">
                            <i data-lucide="bar-chart-2" class="h-5 w-5 mr-2"></i>自社ブランド分析
                        </button>
                        <button data-tab="simulation" class="tab-button flex items-center justify-center text-left sm:justify-start text-sm sm:text-base font-bold py-3 px-4 rounded-lg transition-all duration-300 transform w-full bg-white text-gray-700 hover:bg-gray-200 hover:scale-105">
                            <i data-lucide="zap" class="h-5 w-5 mr-2"></i>戦略シミュレーション
                        </button>
                        <button data-tab="timeseries" class="tab-button flex items-center justify-center text-left sm:justify-start text-sm sm:text-base font-bold py-3 px-4 rounded-lg transition-all duration-300 transform w-full bg-white text-gray-700 hover:bg-gray-200 hover:scale-105">
                            <i data-lucide="trending-up" class="h-5 w-5 mr-2"></i>時系列分析
                        </button>
                    </nav>
                    <main class="lg:col-span-4">
                        <div id="methodology-content" class="content-panel animate-fade-in" style="display: block;">
                            <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                                <h2 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-6 border-b pb-4">使い方・分析方法</h2>
                                <div class="flex border-b mb-6">
                                    <button id="theory-subtab-button" class="py-2 px-4 font-semibold flex items-center border-b-2 border-blue-500 text-blue-600"><i data-lucide="atom" class="h-5 w-5 mr-2"></i>指標と分析の考え方</button>
                                    <button id="guide-subtab-button" class="py-2 px-4 font-semibold flex items-center text-gray-500 border-b-2 border-transparent"><i data-lucide="clipboard-list" class="h-5 w-5 mr-2"></i>データ入力ガイド＆事例集</button>
                                </div>
                                <div id="theory-subtab-content">
                                    <div class="animate-fade-in">
                                        <section class="mb-8 p-6 bg-blue-50 rounded-2xl"><h3 class="text-2xl font-bold text-blue-800 mb-3 flex items-center"><i data-lucide="brain" class="h-7 w-7 mr-3"></i>分析の考え方と基本</h3><p class="text-gray-700 leading-relaxed">この分析手法は、経験や勘に頼るのではなく、データという客観的な事実から市場の「構造」を理解し、再現性の高い戦略を立てることを目指します。そのために、いくつかの重要な「指標（モノサシ）」を使います。</p></section>
                                        <section class="mb-8">
                                            <h3 class="text-xl font-semibold text-gray-800 mb-4">3つの主要指標：あなたのブランドの健康診断</h3>
                                            <div class="p-4 bg-orange-50 border border-orange-200 rounded-lg mb-6"><p class="font-semibold text-orange-800">【重要】分析期間の統一</p><p class="text-sm text-gray-700 mt-1"><span class="font-bold">「①市場の総顧客数」「②購入者数」「③総購入回数」の3つのデータは、必ず同じ期間（例：全て「年間」の数字）で揃えてください。</span></p></div>
                                            <div class="space-y-6">
                                                <div class="p-5 bg-white rounded-xl shadow-md border-l-4 border-purple-500">
                                                    <h4 class="font-bold text-xl text-gray-700 flex items-center"><i data-lucide="star" class="h-6 w-6 mr-2 text-purple-500"></i>プレファレンス (M) = 市場全体からの「好意度」</h4>
                                                    <p class="text-gray-600 mt-3">市場の構造は数学的な法則（負の二項分布）に従っており、その法則の中で私たちが<span class="font-bold">唯一コントロールできる変数が「M」</span>です。だからこそ、Mは<span class="font-bold text-red-600">最も重要な指標</span>と言えます。</p>
                                                    <p class="text-gray-600 mt-2">Mを分かりやすく例えるなら、市場全体で行われる人気投票における<span class="font-bold">「一人当たりの平均投票数」</span>です。市場にいるすべての人（あなたのブランドを買った人＋買わなかった人）が、期間内にあなたのブランドに平均で何票投じてくれたか（＝何回選んでくれたか）を示します。この「一人当たりの平均投票数」を増やすこと、つまりMを向上させることが、マーケティングの最終目的です。</p>
                                                    <div class="mt-4 p-4 bg-gray-100 rounded-lg border border-gray-200">
                                                        <p class="font-semibold text-sm text-gray-800 flex items-center"><i data-lucide="info" class="h-4 w-4 mr-2 text-gray-500"></i>このツールにおける「プレファレンス(M)」の定義について</p>
                                                        <p class="text-xs text-gray-600 mt-2 leading-relaxed">
                                                            このツールで用いる「プレファレンス(M)」は、森岡毅氏の著書「確率思考の戦略論」で定義される需要予測モデルの根幹パラメータ「M（市場全体での平均購入回数）」を指します。これは、一般的なマーケティングで用いられる「配荷率などを考慮した純粋なブランド選択確率」とは定義が異なります。当ツールでは、NBDモデルに基づき、市場のポテンシャル全体（購入者＋非購入者）に対するブランドの購買インパクトを測る指標として、この「M」を一貫して使用しています。
                                                        </p>
                                                    </div>
                                                    <div class="mt-4 p-4 bg-gray-50 rounded-lg"><p class="font-semibold mb-2">【計算の仕組み】</p><code class="block text-center bg-gray-200 text-gray-800 p-2 rounded-md font-mono">プレファレンス(M) = ③ 総購入回数 ÷ ① 市場の総顧客数</code>
                                                        <div class="mt-4 text-sm space-y-4">
                                                            <div><p class="font-bold">【フィットネスジムの例】</p><p><b>《年間》</b>商圏の人口(①)が20,000人で、ジムの総チェックイン回数(③)が30,000回なら、プレファレンスは<b>「30,000 ÷ 20,000 = 1.5」</b>です。</p><p><b>《月間》</b>商圏の人口(①)が20,000人で、総チェックイン回数が2,000回なら、プレファレンスは<b>「2,000 ÷ 20,000 = 0.1」</b>です。</p></div>
                                                            <div><p class="font-bold">【中古品買取店の例】</p><p><b>《年間》</b>商圏のターゲット層(①)が500,000人で、総買取件数(③)が5,000件なら、プレファレンスは<b>「5,000 ÷ 500,000 = 0.01」</b>です。</p><p><b>《月間》</b>商圏のターゲット層(①)が500,000人で、総買取件数が500件なら、プレファレンスは<b>「500 ÷ 500,000 = 0.001」</b>です。</p></div>
                                                            <div><p class="font-bold">【不動産仲介の例】</p><p><b>《年間》</b>担当エリアの総世帯数(①)が50,000世帯で、総契約件数(③)が50件なら、プレファレンスは<b>「50 ÷ 50,000 = 0.001」</b>です。</p><p><b>《月間》</b>担当エリアの総世帯数(①)が50,000世帯で、総契約件数が5件なら、プレファレンスは<b>「5 ÷ 50,000 = 0.0001」</b>です。</p></div>
                                                            <div><p class="font-bold">【学習塾の例】</p><p><b>《年間》</b>担当エリアの高校生人口(①)が10,000人で、総受講コマ数(③)が5,000コマなら、プレファレンスは<b>「5,000 ÷ 10,000 = 0.5」</b>です。</p><p><b>《月間》</b>担当エリアの高校生人口(①)が10,000人で、総受講コマ数が500コマなら、プレファレンスは<b>「500 ÷ 10,000 = 0.05」</b>です。</p></div>
                                                            <div><p class="font-bold">【パチンコホールの例】</p><p><b>《年間》</b>商圏の20歳以上人口(①)が100,000人で、年間の総来店回数(③)が100,000回なら、プレファレンスは<b>「100,000 ÷ 100,000 = 1.0」</b>です。</p><p><b>《月間》</b>商圏の20歳以上人口(①)が100,000人で、月間の総来店回数が10,000回なら、プレファレンスは<b>「10,000 ÷ 100,000 = 0.1」</b>です。</p></div>
                                                        </div>
                                                    </div>
                                                    <div class="mt-4 p-4 bg-purple-50 rounded-lg border border-purple-200"><p class="font-semibold text-purple-800">【Mを伸ばすための2つの方向性】</p><p class="text-sm text-gray-700 mt-2">M（一人当たりの平均投票数）を増やす方法は、大きく2つに分けられます。</p><div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3"><div class="p-3 bg-white rounded-lg"><p class="font-bold">① 水平拡大</p><p class="text-xs mt-1">これまで投票してくれなかった人（新規顧客）にアプローチし、ファン（購入者）の数を増やす戦略。</p></div><div class="p-3 bg-white rounded-lg"><p class="font-bold">② 垂直拡大</p><p class="text-xs mt-1">既存のファン（既存顧客）に、もっと多くの票を投じてもらう（＝購入頻度を上げてもらう）戦略。</p></div></div><p class="text-sm text-gray-700 mt-3">経験上、既存顧客を深掘りする「垂直拡大」よりも、まだ見ぬ顧客が眠る広大な市場を耕す<span class="font-bold">「水平拡大」の方が、ビジネスを大きく成長させる場合が多い</span>とされています。</p></div>
                                                    <div class="mt-4 p-4 bg-red-50 rounded-lg border border-red-200"><p class="font-semibold text-red-800">【結論】Mを伸ばすには「プレファレンス」しかない</p><p class="text-sm text-gray-700 mt-1">では、どうすればMを伸ばせるのか？その唯一の答えが<span class="font-bold">「プレファレンス（Preference）」</span>を高めることです。プレファレンスとは、消費者のブランドに対する<span class="font-bold">「相対的な好意度」</span>。つまり、競合ではなく自社ブランドを選んでもらうための「好み」や「魅力」そのものです。この好意度を高めることだけが、Mを伸ばす唯一の道なのです。</p></div>
                                                </div>
                                                <div class="p-5 bg-white rounded-xl shadow-md border-l-4 border-blue-500">
                                                    <h4 class="font-bold text-xl text-gray-700 flex items-center"><i data-lucide="target" class="h-6 w-6 mr-2 text-blue-500"></i>浸透率 (P) = 市場での「あなたの立ち位置」</h4>
                                                    <p class="text-gray-600 mt-3">あなたのブランドが、定義した市場の中でどれだけ多くの人に届いているか（＝<span class="font-bold">市場内での存在感</span>）を示す指標です。</p>
                                                    <div class="mt-4 p-4 bg-gray-50 rounded-lg"><p class="font-semibold mb-2">【計算の仕組み】</p><code class="block text-center bg-gray-200 text-gray-800 p-2 rounded-md font-mono">浸透率(P) = ② 購入者数 ÷ ① 市場の総顧客数</code>
                                                        <div class="mt-4 text-sm space-y-4">
                                                            <div><p class="font-bold">【フィットネスジムの例】</p><p><b>《年間》</b>商圏の人口(①)が50,000人で、年間の会員数(②)が1,000人なら、浸透率は<b>「1,000 ÷ 50,000 = 2.0%」</b>です。</p><p><b>《月間》</b>商圏の人口(①)が50,000人で、その月に利用した会員(②)が500人なら、月間浸透率は<b>「500 ÷ 50,000 = 1.0%」</b>です。</p></div>
                                                            <div><p class="font-bold">【中古品買取店の例】</p><p><b>《年間》</b>商圏のターゲット層(①)が100万人で、年間の利用客(②)が5,000人なら、浸透率は<b>「5,000 ÷ 1,000,000 = 0.5%」</b>です。</p><p><b>《月間》</b>商圏のターゲット層(①)が100万人で、月間の利用客が500人なら、月間浸透率は<b>「500 ÷ 1,000,000 = 0.05%」</b>です。</p></div>
                                                            <div><p class="font-bold">【不動産仲介の例】</p><p><b>《年間》</b>担当エリアの総世帯数(①)が30,000世帯で、年間に契約した顧客(②)が30世帯なら、浸透率は<b>「30 ÷ 30,000 = 0.1%」</b>です。</p><p><b>《月間》</b>担当エリアの総世帯数(①)が30,000世帯で、その月に契約した顧客が6世帯なら、月間浸透率は<b>「6 ÷ 30,000 = 0.02%」</b>です。</p></div>
                                                            <div><p class="font-bold">【学習塾の例】</p><p><b>《年間》</b>担当エリアの高校生人口(①)が15,000人で、年間の在籍生徒数(②)が150人なら、浸透率は<b>「150 ÷ 15,000 = 1.0%」</b>です。</p><p><b>《月間》</b>担当エリアの高校生人口(①)が15,000人で、その月の在籍生徒数(②)が120人なら、月間浸透率は<b>「120 ÷ 15,000 = 0.8%」</b>です。</p></div>
                                                            <div><p class="font-bold">【パチンコホールの例】</p><p><b>《年間》</b>商圏の20歳以上人口(①)が200,000人で、年間のユニーク来店客数(②)が4,000人なら、浸透率は<b>「4,000 ÷ 200,000 = 2.0%」</b>です。</p><p><b>《月間》</b>商圏の20歳以上人口(①)が200,000人で、その月のユニーク来店客数(②)が1,000人なら、月間浸透率は<b>「1,000 ÷ 200,000 = 0.5%」</b>です。</p></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="p-5 bg-white rounded-xl shadow-md border-l-4 border-green-500">
                                                    <h4 class="font-bold text-xl text-gray-700 flex items-center"><i data-lucide="repeat" class="h-6 w-6 mr-2 text-green-500"></i>平均購入回数 (F) = 購入者の「熱量」</h4>
                                                    <p class="text-gray-600 mt-3">あなたの顧客<span class="font-bold">（一度でも購入した人）</span>が、平均して何回リピートしてくれているかを示す指標です。これが高いほど、顧客満足度が高く、熱心なファンに支えられている証拠です。</p>
                                                    <div class="mt-4 p-4 bg-gray-50 rounded-lg"><p class="font-semibold mb-2">【計算の仕組み】</p><code class="block text-center bg-gray-200 text-gray-800 p-2 rounded-md font-mono">平均購入回数(F) = ③ 総購入回数 ÷ ② 購入者数</code>
                                                        <div class="mt-4 text-sm space-y-4">
                                                            <div><p class="font-bold">【フィットネスジムの例】</p><p><b>《年間》</b>年間の会員数(②)が600人で、総チェックイン回数(③)が7,200回なら、年間平均利用回数は<b>「7,200 ÷ 600 = 12回」</b>です。</p><p><b>《月間》</b>その月の利用者(②)が400人で、総チェックイン回数(③)が1,600回なら、月間平均利用回数は<b>「1,600 ÷ 400 = 4回」</b>です。（週1ペース）</p></div>
                                                            <div><p class="font-bold">【中古品買取店の例】</p><p><b>《年間》</b>年間の買取顧客(②)が1,000人で、総買取件数(③)が1,500件なら、年間平均利用回数は<b>「1,500 ÷ 1,000 = 1.5回」</b>です。</p><p><b>《月間》</b>その月の買取顧客(②)が100人で、総買取件数(③)が110件なら、月間平均利用回数は<b>「110 ÷ 100 = 1.1回」</b>です。</p></div>
                                                            <div><p class="font-bold">【不動産仲介の例】</p><p><b>《年間》</b>年間の契約顧客(②)が50人で、総契約件数(③)が60件なら、年間平均契約件数は<b>「60 ÷ 50 = 1.2件」</b>です。</p><p><b>《月間》</b>(※不動産のような低頻度商材では、より長い期間で見るのが一般的です)<br/>その月の契約顧客(②)が3人で、総契約件数(③)が3件なら、月間平均契約件数は<b>「3 ÷ 3 = 1.0件」</b>です。</p></div>
                                                            <div><p class="font-bold">【学習塾の例】</p><p><b>《年間》</b>年間の在籍生徒(②)が50人で、総受講コマ数(③)が4,000コマなら、年間平均受講回数は<b>「4,000 ÷ 50 = 80回」</b>です。</p><p><b>《月間》</b>その月の在籍生徒(②)が100人で、総受講コマ数(③)が800コマなら、月間平均受講回数は<b>「800 ÷ 100 = 8回」</b>です。（週2ペース）</p></div>
                                                            <div><p class="font-bold">【パチンコホールの例】</p><p><b>《年間》</b>年間のユニーク来店客数(②)が3,000人で、年間の総来店回数(③)が36,000回なら、年間平均来店回数は<b>「36,000 ÷ 3,000 = 12回」</b>です。（月1ペース）</p><p><b>《月間》</b>その月のユニーク来店客数(②)が800人で、月間の総来店回数(③)が2,400回なら、月間平均来店回数は<b>「2,400 ÷ 800 = 3回」</b>です。</p></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </section>
                                        <section class="mb-8">
                                            <h3 class="text-xl font-semibold text-gray-800 mb-4">【重要】MとFの違い：なぜMが最重要なのか？</h3>
                                            <div class="p-5 bg-white rounded-xl shadow-md border-l-4 border-red-500">
                                                <p class="text-gray-700 leading-relaxed">この2つの指標は似ていますが、見ている範囲が全く違います。この違いを理解することが、正しい戦略への第一歩です。</p>
                                                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <div class="p-4 bg-purple-50 rounded-lg"><p class="font-bold text-purple-700 text-lg">プレファレンス (M)</p><p class="font-semibold mt-1">【視点】市場全体（購入者＋非購入者）</p><p class="text-sm mt-2">市場にいる<span class="font-bold">全員</span>を対象に、「一人あたり何回買ってくれたか」を見ています。ブランドを知っているけど買わない人、そもそも知らない人も含めた上での平均値なので、これは<span class="font-bold">市場全体からの評価（好意度）</span>と言えます。</p></div>
                                                    <div class="p-4 bg-green-50 rounded-lg"><p class="font-bold text-green-700 text-lg">平均購入回数 (F)</p><p class="font-semibold mt-1">【視点】購入者のみ</p><p class="text-sm mt-2"><span class="font-bold">一度でも買ってくれたお客様だけ</span>を対象に、「一人あたり何回買ってくれたか」を見ています。これは、既存顧客の<span class="font-bold">ロイヤリティや満足度（熱量）</span>を測る指標です。</p></div>
                                                </div>
                                                <div class="mt-6 p-4 bg-red-50 rounded-lg border border-red-200"><p class="font-semibold text-red-800">【結論】ビジネスの成長 ＝ Mを増やすこと</p><p class="text-sm text-gray-700 mt-1">Fが高い（ファンに愛されている）ことは素晴らしいですが、それだけではビジネスは大きく成長しません。市場にいる<span class="font-bold">まだ見ぬ顧客や、買ってくれない人たち</span>を振り向かせ、市場全体での好意度（M）を高めることこそが、売上を増やすための本質的な戦略なのです。</p></div>
                                            </div>
                                        </section>
                                        <section class="mb-8">
                                            <h3 class="text-xl font-semibold text-gray-800 mb-4">【深掘り】なぜこの分析は当たるのか？</h3>
                                            <div class="p-5 bg-white rounded-xl shadow-md border-l-4 border-cyan-500 space-y-6">
                                                <div><h4 class="font-bold text-xl text-gray-700 flex items-center"><i data-lucide="user" class="h-6 w-6 mr-2 text-cyan-500"></i>ステップ1: 個人の購買はランダム（ポアソン分布）</h4><p class="text-gray-600 mt-3">顧客<span class="font-bold">一人ひとり</span>の購買行動は、基本的にはランダムです。例えば、「Aさんは平均して月に3回ジュースを買う」としても、毎月きっかり3回買うわけではなく、ある月は1回、別の月は5回かもしれません。</p></div>
                                                <div class="text-center text-2xl font-bold text-gray-400">＋</div>
                                                <div><h4 class="font-bold text-xl text-gray-700 flex items-center"><i data-lucide="users" class="h-6 w-6 mr-2 text-cyan-500"></i>ステップ2: 市場には様々な人がいる（ガンマ分布）</h4><p class="text-gray-600 mt-3">しかし、市場にはAさんのような「平均月3回」の人だけでなく、「月1回」の人も「月10回」の人もいます。このように、<span class="font-bold">購買頻度の異なる、様々なタイプの顧客が混在している</span>のが現実の市場です。</p></div>
                                                <div class="p-4 mt-4 bg-cyan-50 rounded-lg border border-cyan-200"><p class="font-semibold text-cyan-800">【結論】だから市場は「負の二項分布」に従う</p><p class="text-sm text-gray-700 mt-1">この2つの事実を掛け合わせると、市場全体の購入回数分布は「負の二項分布（NBD）」という決まった形になります。そして、その分布の「ばらつき度合い」を決めているのが<span class="font-bold">「K値」</span>です。K値が小さい（ファン集中型）ほどばらつきが大きく、一部のヘビーユーザーが売上を支えていることを意味します。このK値を仮説として設定することで、より現実に近い市場構造の予測が可能になるのです。</p></div>
                                            </div>
                                        </section>
                                        <section class="mb-8"><h3 class="text-xl font-semibold text-gray-800 mb-4">【応用編】K値の考え方：あなたの顧客はどんなタイプ？</h3><div class="p-5 bg-white rounded-xl shadow-md border-l-4 border-yellow-500"><div class="flex items-center"><i data-lucide="users-2" class="h-6 w-6 mr-2 text-yellow-500"></i><h4 class="font-bold text-xl text-gray-700">K値 = 顧客構造の「偏り」を測るモノサシ</h4></div><p class="text-gray-600 mt-3">K値は、あなたのビジネスが「一部の熱狂的なファン」に支えられているのか、それとも「多くのライトな顧客」に支えられているのか、その<span class="font-bold">顧客タイプの偏り</span>を数字で表すものです。</p><div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4"><div class="p-4 bg-red-50 rounded-lg"><p class="font-bold text-red-700">K値が小さい (0.1~0.8)</p><p class="font-semibold mt-1">「ファン集中型」ビジネス</p><p class="text-sm mt-2">例：週に何度も通う常連さんがいるラーメン店、高額でも指名買いされる専門ブランド、<b>特定の美容師を指名する美容院、ニッチな趣味の専門店</b>など。「このお店じゃなきゃダメ」というファンが売上の中心。</p></div><div class="p-4 bg-blue-50 rounded-lg"><p class="font-bold text-blue-700">K値が大きい (1.0~)</p><p class="font-semibold mt-1">「大衆利用型」ビジネス</p><p class="text-sm mt-2">例：多くの人がたまに利用するファストフード店やスーパーの日用品、<b>コンビニ、ドラッグストア</b>など。特定のファンに偏らず、広く浅く利用される。</p></div></div></div><div class="p-5 mt-6 bg-yellow-50 rounded-xl border border-yellow-200"><h4 class="font-bold text-lg text-yellow-800 mb-3">では、K値はどうやって決めるの？</h4><p class="text-gray-700 mb-4">K値は、顧客ID付きの詳細な購買データがないと正確な計算は困難です。しかし、このツールでは<span class="font-bold">「仮説を立ててシミュレーションする」</span>ことを重視します。以下のステップで、あなたのビジネスのK値を仮設定してみましょう。</p><ol class="list-decimal list-inside space-y-3"><li><b>ステップ1：自社の顧客を思い浮かべる</b><br/><span class="text-sm">「うちのお客さんは、いつも同じ顔ぶれが多いかな？それとも、毎回新しい人が多いかな？」と考えてみましょう。</span></li><li><b>ステップ2：2つのタイプ、どちらに近いか考える</b><br/><span class="text-sm">上記の「ファン集中型」と「大衆利用型」、自社のビジネスはどちらの特徴が強いか、直感で判断します。</span></li><li><b>ステップ3：スライダーで仮説のK値を設定する</b><br/><span class="text-sm">「ファン集中型」だと思うなら、スライダーを左側（0.2〜0.8程度）に。「大衆利用型」だと思うなら、右側（1.0〜2.5程度）に設定します。一般的な消費財では0.5〜2.5の範囲に収まることが多いです。</span></li></ol><p class="text-sm mt-4 p-3 bg-white rounded-md">このツールの一番の目的は、このK値の仮説を動かしながら「もし、うちの顧客構造がもっとファン集中型だったら、どうなる？」「もっと大衆向けにするには、何が必要？」と、<span class="font-bold">戦略的な思考を巡らせること</span>にあります。</p></div></section>
                                        <section class="mb-8">
                                            <h3 class="text-xl font-semibold text-gray-800 mb-4">【重要】グラフの「0回購入」顧客とは？</h3>
                                            <div class="p-5 bg-white rounded-xl shadow-md border-l-4 border-teal-500">
                                                <h4 class="font-bold text-xl text-gray-700">彼らは「顧客ではない」のではなく、「休眠顧客」という宝の山です。</h4>
                                                <p class="text-gray-600 mt-3">「自社ブランド分析」のグラフで「0回購入」に人数が表示されるのは、一見不思議に思えるかもしれません。これは、「分析期間中に購入しなかったが、あなたの顧客リストには含まれている人たち」を、モデルが予測していることを意味します。</p>
                                                <p class="text-gray-600 mt-2">例えば、ジュース屋さんの常連（顧客リストにいる人）でも、たまたまその月だけ一度もジュースを買いに来なかった、ということがありますよね。その「今月は休んでいる常連さん」が、この「0回購入客」にあたります。</p>
                                                <p class="font-bold text-teal-700 mt-4">彼らは、あなたのことを既に知っているため、新規顧客を獲得するよりもはるかに少ないコストで、再びアクティブな顧客になってもらえる可能性があります。DMや特別なオファーで「お久しぶりです！」と声をかけることで、掘り起こせるかもしれない「宝の山」なのです。</p>
                                            </div>
                                        </section>
                                    </div>
                                </div>
                                <div id="guide-subtab-content" style="display: none;">
                                    <div class="animate-fade-in">
                                        <section class="mb-8"><h3 class="text-xl font-semibold text-gray-800 mb-3">Part 1: データの集め方・考え方（業種別・詳細ガイド）</h3>
                                            <p class="text-gray-700 leading-relaxed mb-4">「どの数字を入れればいいの？」という疑問は、このツールを使う上で最も重要なポイントです。ここでは、主要な業種別に、3つの基本データを「どのような切り口で考え、どこから情報を集めればよいか」を、複数のパターンで詳しく解説します。ご自身のビジネスに最も近い考え方を見つけ、まずは概算でも良いので数値を当てはめてみましょう。</p>
                                            <div class="space-y-6" id="industry-guides-container"></div>
                                        </section>
                                        <section>
                                            <h3 class="text-xl font-semibold text-gray-800 my-4">Part 2: 参考事例から分析を体験する</h3>
                                            <div class="space-y-6" id="case-studies-container"></div>
                                        </section>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="howToUse-content" class="content-panel">
                             <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg animate-fade-in">
                                <h2 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-6 border-b pb-4">分析結果の活用法：売上と利益に繋げる思考</h2>
                                <section class="mb-8">
                                    <h3 class="text-xl font-semibold text-gray-800 mb-4">各分析タブの活用方針</h3>
                                    <div class="space-y-4">
                                        <div class="p-4 border rounded-lg bg-gray-50">
                                            <h4 class="font-bold text-gray-800 flex items-center"><i data-lucide="bar-chart-2" class="h-5 w-5 mr-2 text-blue-500"></i>自社ブランド分析</h4>
                                            <p class="text-sm text-gray-600 mt-2">自社の「浸透率」と「平均購入回数」の現在地を正確に把握します。業界平均や競合と比較してどちらが弱いか（または伸ばす余地があるか）を特定し、戦略の大きな方向性（新規顧客獲得 or リピート促進）を決定するための出発点です。</p>
                                        </div>
                                        <div class="p-4 border rounded-lg bg-gray-50">
                                            <h4 class="font-bold text-gray-800 flex items-center"><i data-lucide="zap" class="h-5 w-5 mr-2 text-yellow-500"></i>戦略シミュレーション</h4>
                                            <p class="text-sm text-gray-600 mt-2">「もし購入者数を10%増やしたら、売上と利益はどうなる？」といった仮説検証（What-if分析）を行います。ここで立てた目標が、投資対効果（ROI）に見合うかを事前に判断するための重要なステップです。</p>
                                        </div>
                                        <div class="p-4 border rounded-lg bg-gray-50">
                                            <h4 class="font-bold text-gray-800 flex items-center"><i data-lucide="trending-up" class="h-5 w-5 mr-2 text-indigo-500"></i>時系列分析</h4>
                                            <p class="text-sm text-gray-600 mt-2">過去の施策と結果の因果関係を分析します。「3ヶ月前のWeb広告は浸透率を0.2%上げた」という事実が分かれば、その施策のROIを計算し、今後の投資判断の材料とすることができます。</p>
                                        </div>
                                    </div>
                                </section>
                                <section class="mb-8">
                                    <h3 class="text-xl font-semibold text-gray-800 mb-3">【重要】プレファレンスが利益に変わるまで</h3>
                                    <p class="text-gray-700 leading-relaxed mb-4">このツールで最も重要な「プレファレンス(M)」が、最終的にどうやってクライアントが望む「利益」に繋がるのか。その関係性を理解することが、説得力のある提案の鍵となります。</p>
                                    <div class="space-y-4">
                                        <div class="p-4 border rounded-lg bg-gray-50">
                                            <h4 class="font-bold text-gray-800 flex items-center"><span class="flex items-center justify-center w-6 h-6 bg-purple-500 text-white rounded-full mr-2 text-sm font-bold">1</span>総購入回数を予測する</h4>
                                            <p class="text-sm text-gray-600 mt-2">プレファレンス(M)は「市場の顧客一人あたりの平均購入回数」です。つまり、これに市場全体の人数を掛ければ、あなたのブランドの総購入回数が予測できます。</p>
                                            <code class="block text-center mt-2 bg-gray-200 text-gray-800 p-2 rounded-md font-mono">総購入回数 = ① 市場の総顧客数 × プレファレンス(M)</code>
                                            <p class="text-xs text-gray-500 mt-2">例：市場が150,000人で、Mが0.048なら、年間の総購入回数は 150,000人 × 0.048 = 7,200回 と予測できます。</p>
                                        </div>
                                        <div class="p-4 border rounded-lg bg-gray-50">
                                            <h4 class="font-bold text-gray-800 flex items-center"><span class="flex items-center justify-center w-6 h-6 bg-purple-500 text-white rounded-full mr-2 text-sm font-bold">2</span>売上を算出する</h4>
                                            <p class="text-sm text-gray-600 mt-2">予測した総購入回数に、顧客一人あたりの平均購入単価を掛ければ、売上が算出できます。</p>
                                            <code class="block text-center mt-2 bg-gray-200 text-gray-800 p-2 rounded-md font-mono">売上 = 総購入回数 × 平均購入単価</code>
                                            <p class="text-xs text-gray-500 mt-2">例：総購入回数が7,200回で、平均単価が7,800円なら、年間売上は 7,200回 × 7,800円 = 56,160,000円 となります。</p>
                                        </div>
                                        <div class="p-4 border rounded-lg bg-gray-50">
                                            <h4 class="font-bold text-gray-800 flex items-center"><span class="flex items-center justify-center w-6 h-6 bg-purple-500 text-white rounded-full mr-2 text-sm font-bold">3</span>利益を計算する</h4>
                                            <p class="text-sm text-gray-600 mt-2">最後に、算出した売上から原価を引けば、粗利が計算できます。マーケティング施策の提案では、この粗利から広告費などの投資額を引いた「投資対効果(ROI)」を示すことが重要です。</p>
                                            <code class="block text-center mt-2 bg-gray-200 text-gray-800 p-2 rounded-md font-mono">粗利 = 売上 - (売上 × 原価率)</code>
                                            <p class="text-xs text-gray-500 mt-2">例：売上が5,616万円で原価率が30%なら、粗利は 5,616万円 - (5,616万円 × 0.3) = 3,931.2万円 となります。</p>
                                        </div>
                                    </div>
                                     <div class="mt-6 p-4 bg-purple-50 rounded-lg border border-purple-200"><p class="font-semibold text-purple-800">【結論】プレファレンス(M)を上げれば、利益は増える</p><p class="text-sm text-gray-700 mt-1">この3ステップを見れば明らかなように、全ての計算の出発点は「プレファレンス(M)」です。つまり、<span class="font-bold">市場全体からの好意度(M)を高める施策こそが、最終的にクライアントの利益を最大化する最も確実な道筋</span>なのです。</p></div>
                                </section>
                                <section class="mb-8">
                                    <h3 class="text-xl font-semibold text-gray-800 mb-3">ビジネスの成果 ＝ 3つのレバー</h3>
                                    <p class="text-gray-700 leading-relaxed">このツールの分析結果をビジネスの成長に繋げるには、まず全てのビジネスに共通する「売上の方程式」を理解することが重要です。</p>
                                    <div class="my-4 p-4 bg-yellow-50 text-center rounded-lg"><code class="text-lg md:text-xl font-bold text-yellow-900">売上 = ①購入者数 × ②平均購入回数 × ③平均購入単価</code></div>
                                    <p class="text-gray-700 leading-relaxed">あなたのビジネスの売上は、この3つの要素の掛け算で決まります。そして、このツールの分析指標は、この方程式のレバーと直接的に連動しています。</p>
                                    <ul class="list-disc list-inside space-y-2 mt-4 text-gray-700">
                                        <li><span class="font-bold text-purple-600">市場からの好意度</span>を上げる ⇔ <span class="font-bold">「プレファレンス(M)」</span>を上げる（最重要）</li>
                                        <li><span class="font-bold text-blue-600">① 購入者数</span>を増やす ⇔ <span class="font-bold">「浸透率(P)」</span>を上げる</li>
                                        <li><span class="font-bold text-green-600">② 平均購入回数</span>を増やす ⇔ <span class="font-bold">「平均購入回数(F)」</span>を上げる</li>
                                        <li><span class="font-bold text-orange-600">③ 平均購入単価</span>を上げる ⇔ 商品価値を高め、より高い価格でも選ばれるようにする</li>
                                    </ul>
                                </section>
                            </div>
                        </div>
                        <div id="single-content" class="content-panel">
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg">
                                    <h3 class="text-xl font-semibold mb-4 border-b pb-3">自社ブランド分析</h3>
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">分析期間</label>
                                        <div class="flex rounded-lg shadow-sm">
                                            <button id="single-period-annual" class="w-full px-4 py-2 rounded-l-lg bg-blue-600 text-white">年間</button>
                                            <button id="single-period-monthly" class="w-full px-4 py-2 rounded-r-lg bg-white text-gray-700 hover:bg-gray-50">月間</button>
                                        </div>
                                    </div>
                                    <div class="space-y-4">
                                        <div><label id="single-purchases-label" class="block text-sm font-medium text-gray-700">年間の総購入回数</label><input type="number" id="single-total-purchases" value="7200" class="w-full p-3 border border-gray-300 rounded-lg"/></div>
                                        <div><label id="single-buyers-label" class="block text-sm font-medium text-gray-700">年間の購入者数</label><input type="number" id="single-brand-buyers" value="600" class="w-full p-3 border border-gray-300 rounded-lg"/></div>
                                    </div>
                                    <div class="mt-6 p-4 bg-indigo-50 rounded-lg border border-indigo-200"><h4 class="font-semibold text-indigo-800 mb-3">【任意】AIコンサルタントへの追加情報</h4><div class="space-y-4"><div><label class="text-sm font-medium text-gray-700">業種・ビジネスタイプ</label><input type="text" id="single-ai-industry" class="w-full p-2 border border-gray-300 rounded-lg mt-1" placeholder="例: 飲食店、小売、SaaS"/></div><div><label class="text-sm font-medium text-gray-700">主な商品・サービス（価格帯も）</label><textarea id="single-ai-products" rows="2" class="w-full p-2 border border-gray-300 rounded-lg mt-1" placeholder="例: こだわり醤油ラーメン（900円）"></textarea></div><div><label class="text-sm font-medium text-gray-700">ターゲット顧客層</label><textarea id="single-ai-target" rows="2" class="w-full p-2 border border-gray-300 rounded-lg mt-1" placeholder="例: 20代〜30代の男性、近隣のオフィスワーカー"></textarea></div><div><label class="text-sm font-medium text-gray-700">自社の強みやこだわり</label><textarea id="single-ai-strengths" rows="2" class="w-full p-2 border border-gray-300 rounded-lg mt-1" placeholder="例: 国産素材のみ使用、創業50年の伝統"></textarea></div></div></div>
                                    <div class="mt-6 flex flex-col space-y-3">
                                        <button id="single-analyze-button" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300 shadow-md flex items-center justify-center"><i data-lucide="bar-chart-2" class="h-5 w-5 mr-2"></i> 分析実行</button>
                                        <button id="single-ai-button" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors duration-300 shadow-md flex items-center justify-center disabled:bg-gray-400 disabled:cursor-not-allowed" disabled><i data-lucide="bot" class="h-5 w-5 mr-2"></i> AI戦略レポートを依頼</button>
                                    </div>
                                    <div id="single-error" class="mt-4 text-sm text-red-600 bg-red-100 p-3 rounded-lg" style="display: none;"></div>
                                </div>
                                <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                                    <h3 class="text-xl font-semibold mb-4 border-b pb-3">分析結果</h3>
                                    <div id="single-results-container" class="text-gray-500 flex items-center justify-center h-full min-h-[400px]">データを入力して「分析実行」を押してください。</div>
                                </div>
                            </div>
                        </div>
                        <div id="simulation-content" class="content-panel">
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg">
                                    <h3 class="text-xl font-semibold mb-4 border-b pb-3">戦略シミュレーション</h3>
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">分析期間</label>
                                        <div class="flex rounded-lg shadow-sm">
                                            <button id="sim-period-annual" class="w-full px-4 py-2 rounded-l-lg bg-blue-600 text-white">年間</button>
                                            <button id="sim-period-monthly" class="w-full px-4 py-2 rounded-r-lg bg-white text-gray-700 hover:bg-gray-50">月間</button>
                                        </div>
                                    </div>
                                    <div class="space-y-4">
                                        <fieldset class="border p-4 rounded-lg"><legend class="px-2 font-semibold text-gray-700">現状 (As-Is)</legend><div><label id="sim-buyers-label" class="block text-sm font-medium text-gray-700 mb-1">年間の購入者数</label><input type="number" id="sim-base-buyers" value="1000" class="w-full p-3 border border-gray-300 rounded-lg"/></div><div class="mt-4"><label id="sim-freq-label" class="block text-sm font-medium text-gray-700 mb-1">年間の平均購入回数</label><input type="number" step="0.1" id="sim-base-frequency" value="12.0" class="w-full p-3 border border-gray-300 rounded-lg"/></div></fieldset>
                                        <fieldset class="border p-4 rounded-lg">
                                            <legend class="px-2 font-semibold text-gray-700">目標 (To-Be)</legend>
                                            <div class="flex justify-around mb-4 text-sm">
                                                <label class="flex items-center cursor-pointer"><input type="radio" name="simTargetType" value="buyers" checked class="mr-1"/>購入者数</label>
                                                <label class="flex items-center cursor-pointer"><input type="radio" name="simTargetType" value="penetration" class="mr-1"/>浸透率</label>
                                                <label class="flex items-center cursor-pointer"><input type="radio" name="simTargetType" value="frequency" class="mr-1"/>平均購入回数</label>
                                            </div>
                                            <div id="sim-target-buyers-input"><label class="block text-sm font-medium text-gray-700 mb-1">目標購入者数 (人)</label><input type="number" id="sim-target-buyers" value="1050" class="w-full p-3 border border-gray-300 rounded-lg"/></div>
                                            <div id="sim-target-penetration-input" style="display:none;"><label class="block text-sm font-medium text-gray-700 mb-1">目標浸透率 (%)</label><input type="number" id="sim-target-penetration" value="0.7" class="w-full p-3 border border-gray-300 rounded-lg"/></div>
                                            <div id="sim-target-frequency-input" style="display:none;"><label class="block text-sm font-medium text-gray-700 mb-1">目標平均購入回数 (回)</label><input type="number" step="0.1" id="sim-target-frequency" value="12.5" class="w-full p-3 border border-gray-300 rounded-lg"/></div>
                                        </fieldset>
                                        <fieldset class="border p-4 rounded-lg"><legend class="px-2 font-semibold text-gray-700">利益計算</legend>
                                            <div class="space-y-4">
                                                <div>
                                                    <div class="flex items-center mb-1">
                                                        <label class="block text-sm font-medium text-gray-700">1購入あたりの平均利益 (円)</label>
                                                        <div class="tooltip-container ml-2">
                                                            <i data-lucide="help-circle" class="text-gray-400 tooltip-trigger" style="width: 16px; height: 16px;"></i>
                                                            <div class="tooltip-content" style="width: 280px;">
                                                                <b>都度払いモデル(飲食店/小売/買取など):</b><br>平均客単価 - 平均原価<br><br>
                                                                <b>月額会費制モデル(ジム/SaaSなど):</b><br>月額会費 - 月間費用
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <input type="number" id="sim-avg-profit" value="5460" class="w-full p-2 border border-gray-300 rounded-lg mt-1"/>
                                                </div>
                                                <div><label class="block text-sm font-medium text-gray-700">マーケティング予算 (円)</label><input type="number" id="sim-budget" value="1000000" class="w-full p-2 border border-gray-300 rounded-lg mt-1" placeholder="例: 500000"/></div>
                                            </div>
                                        </fieldset>
                                         <div class="p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                                            <h4 class="font-semibold text-indigo-800 mb-3">【任意】AIコンサルタントへの追加情報</h4>
                                            <div class="space-y-4">
                                                <div><label class="text-sm font-medium text-gray-700">業種・ビジネスタイプ</label><input type="text" id="sim-ai-industry" class="w-full p-2 border border-gray-300 rounded-lg mt-1" placeholder="例: 飲食店、小売、SaaS"/></div>
                                                <div><label class="text-sm font-medium text-gray-700">ターゲット顧客層</label><textarea id="sim-ai-target" rows="2" class="w-full p-2 border border-gray-300 rounded-lg mt-1" placeholder="例: 20代〜30代の男性、近隣のオフィスワーカー"></textarea></div>
                                                <div><label class="text-sm font-medium text-gray-700">自社の強み</label><textarea id="sim-ai-strengths" rows="2" class="w-full p-2 border border-gray-300 rounded-lg mt-1" placeholder="例: 国産素材のみ使用、創業50年の伝統"></textarea></div>
                                                <div><label class="text-sm font-medium text-gray-700">目標達成のための前提条件・制約など</label><textarea id="sim-ai-context" rows="2" class="w-full p-2 border border-gray-300 rounded-lg mt-1" placeholder="例: ブランドイメージを重視するため、安売りは避けたい。"></textarea></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-6 flex flex-col space-y-3">
                                        <button id="sim-run-button" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300 shadow-md flex items-center justify-center"><i data-lucide="zap" class="h-5 w-5 mr-2"></i> シミュレーション実行</button>
                                        <button id="sim-ai-button" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors duration-300 shadow-md flex items-center justify-center disabled:bg-gray-400 disabled:cursor-not-allowed" disabled><i data-lucide="bot" class="h-5 w-5 mr-2"></i> AI戦略レポートを依頼</button>
                                    </div>
                                </div>
                                <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                                    <h3 class="text-xl font-semibold mb-4 border-b pb-3">シミュレーション結果</h3>
                                    <div id="sim-results-container" class="text-gray-500 flex items-center justify-center h-full min-h-[400px]">現状と目標を入力して、「シミュレーション実行」を押してください。</div>
                                </div>
                            </div>
                        </div>
                        <div id="timeseries-content" class="content-panel">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <div class="bg-white p-6 rounded-2xl shadow-lg">
                                    <h3 class="text-xl font-semibold mb-4 border-b pb-3">時系列データ入力</h3>
                                    <div id="timeseries-data-container" class="space-y-3 max-h-[45vh] overflow-y-auto pr-2 custom-scrollbar">
                                    </div>
                                    <button id="timeseries-add-period-button" class="mt-4 w-full border-2 border-dashed border-gray-300 text-gray-500 font-bold py-2 px-4 rounded-lg hover:bg-gray-100 hover:text-gray-700 transition flex items-center justify-center"><i data-lucide="plus-circle" class="h-5 w-5 mr-2"></i> 期間を追加</button>
                                    <div class="mt-6 p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                                        <h4 class="font-semibold text-indigo-800 mb-3">【任意】AIコンサルタントへの追加情報</h4>
                                        <div class="space-y-4">
                                            <div><label class="text-sm font-medium text-gray-700">業種・ビジネスタイプ</label><input type="text" id="timeseries-ai-industry" class="w-full p-2 border border-gray-300 rounded-lg mt-1" placeholder="例: 飲食店、小売、SaaS"/></div>
                                            <div><label class="text-sm font-medium text-gray-700">ターゲット顧客層</label><textarea id="timeseries-ai-target" rows="2" class="w-full p-2 border border-gray-300 rounded-lg mt-1" placeholder="例: 20代〜30代の男性、近隣のオフィスワーカー"></textarea></div>
                                            <div><label class="text-sm font-medium text-gray-700">市場全体の動向や内部的な課題</label><textarea id="timeseries-ai-context" rows="3" class="w-full p-2 border border-gray-300 rounded-lg mt-1" placeholder="例: 業界全体のトレンド、競合の大きな動き、自社の経営方針の変更など..."></textarea></div>
                                        </div>
                                    </div>
                                    <button id="timeseries-ai-button" class="mt-4 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors duration-300 shadow-md flex items-center justify-center"><i data-lucide="bot" class="h-5 w-5 mr-2"></i> AI時系列レポートを依頼</button>
                                </div>
                                <div class="bg-white p-6 rounded-2xl shadow-lg">
                                    <h3 class="text-xl font-semibold mb-4 border-b pb-3">ブランド指標トレンド</h3>
                                    <div id="timeseries-chart-container" class="w-full h-80 bg-gray-50 p-4 rounded-lg relative">
                                    </div>
                                    <div id="timeseries-chart-legend" class="flex justify-center items-center gap-x-6 mt-2">
                                    </div>
                                    <div id="chart-tooltip" class="chart-tooltip"></div>
                                    <h3 class="text-xl font-semibold mb-4 border-b pb-3 mt-8">詳細データ</h3>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm text-left">
                                            <thead class="bg-gray-100">
                                                <tr>
                                                    <th class="p-2">期間</th>
                                                    <th class="p-2">プレファレンススコア</th>
                                                    <th class="p-2">浸透率(%)</th>
                                                    <th class="p-2">平均購入回数(F)</th>
                                                    <th class="p-2">主な出来事</th>
                                                </tr>
                                            </thead>
                                            <tbody id="timeseries-results-table">
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="mt-8">
                                        <h3 class="text-xl font-semibold mb-4 border-b pb-3 flex items-center"><i data-lucide="bot" class="h-6 w-6 mr-2 text-indigo-500"></i> AIコンサルタントの要因分析レポート</h3>
                                        <div id="timeseries-ai-report" class="prose">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // ===== SUPABASE & AUTHENTICATION LOGIC =====
    const supabaseUrl = 'https://zflsgqzuvcnahxmthjpk.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmbHNncXp1dmNuYWh4bXRoanBrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE1MTE1NzMsImV4cCI6MjA2NzA4NzU3M30.P1dLtsIorP7PoKkL97UCJ3UmIm_OQFu0NPJNmCOZV1I';
    let supabaseClient;

    // Check if Supabase credentials are placeholders
    if (supabaseUrl.startsWith('YOUR_SUPABASE_URL') || supabaseAnonKey.startsWith('YOUR_SUPABASE_ANON_KEY')) {
        console.error("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!");
        console.error("!!! SUPABASE ERROR: supabaseUrl and supabaseAnonKey are not set in index.html.");
        console.error("!!! Please replace 'YOUR_SUPABASE_URL' and 'YOUR_SUPABASE_ANON_KEY' with your actual Supabase credentials.");
        console.error("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!");
        
        const loadingSection = document.getElementById('loading-section');
        const loginSection = document.getElementById('login-section');
        const authContainer = document.getElementById('auth-container');

        if (loadingSection && loginSection && authContainer) {
            loadingSection.innerHTML = `
                <div class="max-w-md w-full bg-red-100 text-red-800 p-6 rounded-lg shadow-md text-left">
                    <h3 class="font-bold text-lg">設定エラー</h3>
                    <p class="mt-2 text-sm">SupabaseのURLとキーが設定されていません。<code>index.html</code>ファイルを編集して、'YOUR_SUPABASE_URL' と 'YOUR_SUPABASE_ANON_KEY' を、あなたがSupabaseで取得した実際の値に置き換えてください。</p>
                </div>
            `;
            authContainer.style.display = 'flex';
            loadingSection.style.display = 'block';
            loginSection.style.display = 'none';
        }
        return; // Stop the script execution if credentials are not set
    }
    
    supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

    const appContainer = document.getElementById('app-container');
    const authContainer = document.getElementById('auth-container');
    const loadingSection = document.getElementById('loading-section');
    const loginSection = document.getElementById('login-section');
    const logoutButton = document.getElementById('logout-button');
    const loginForm = document.getElementById('login-form');
    const emailInput = document.getElementById('email-input');
    const passwordInput = document.getElementById('password-input');
    const authTitle = document.getElementById('auth-title');
    const authSubtitle = document.getElementById('auth-subtitle');
    const authButton = document.getElementById('auth-button');
    const authPromptText = document.getElementById('auth-prompt-text');
    const toggleAuthModeLink = document.getElementById('toggle-auth-mode');
    const authError = document.getElementById('auth-error');
    const authSuccess = document.getElementById('auth-success');

    let isSignUpMode = false;
    let toolInitialized = false;

    const updateAuthUI = (state) => {
        console.log(`%c[Auth] UI state updated to: ${state}`, 'color: #28a745;');
        loadingSection.style.display = 'none';
        loginSection.style.display = 'none';
        authContainer.style.display = 'none';
        appContainer.style.display = 'none';

        switch (state) {
            case 'LOADING':
                authContainer.style.display = 'flex';
                loadingSection.style.display = 'block';
                break;
            case 'LOGIN':
                authContainer.style.display = 'flex';
                loginSection.style.display = 'block';
                break;
            case 'APP':
                appContainer.style.display = 'block';
                if (!toolInitialized) {
                    initializeAppLogic();
                    toolInitialized = true;
                }
                break;
        }
    };
    
    supabaseClient.auth.onAuthStateChange((event, session) => {
        console.log(`%c[Auth] onAuthStateChange event: ${event}`, 'background: #ffc107; color: black;');
        if (session) {
            updateAuthUI('APP');
        } else {
            updateAuthUI('LOGIN');
        }
    });

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        authError.textContent = '';
        authError.style.display = 'none';
        authSuccess.textContent = '';
        authSuccess.style.display = 'none';
        authButton.disabled = true;
        authButton.textContent = isSignUpMode ? '登録中...' : 'ログイン中...';

        const email = emailInput.value;
        const password = passwordInput.value;

        try {
            if (isSignUpMode) {
                console.log(`[Auth] Attempting sign up for ${email}`);
                const { error } = await supabaseClient.auth.signUp({ 
                    email, 
                    password,
                    options: {
                        emailRedirectTo: `${window.location.origin}/auth-verify.html`
                    }
                });
                if (error) throw error;
                console.log(`[Auth] Sign up successful for ${email}. Confirmation email sent.`);
                authSuccess.textContent = '確認メールを送信しました。メール内のリンクをクリックして登録を完了してください。';
                authSuccess.style.display = 'block';
            } else {
                console.log(`[Auth] Attempting sign in for ${email}`);
                const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;
                console.log(`[Auth] Sign in successful for ${email}.`);
            }
        } catch (error) {
            console.error('[Auth] Error:', error.message);
            authError.textContent = `エラー: ${error.message}`;
            authError.style.display = 'block';
        } finally {
            authButton.disabled = false;
            authButton.textContent = isSignUpMode ? '新規登録' : 'ログイン';
        }
    });
    
    toggleAuthModeLink.addEventListener('click', (e) => {
        e.preventDefault();
        isSignUpMode = !isSignUpMode;
        loginForm.reset();
        authError.style.display = 'none';
        authSuccess.style.display = 'none';
        
        authTitle.textContent = isSignUpMode ? '新規登録' : 'ログイン';
        authSubtitle.textContent = isSignUpMode ? 'ツールを利用するには新規登録が必要です。' : 'ツールを利用するにはログインが必要です。';
        authButton.textContent = isSignUpMode ? '新規登録' : 'ログイン';
        authPromptText.textContent = isSignUpMode ? 'すでにアカウントをお持ちですか？' : 'アカウントをお持ちでないですか？';
        toggleAuthModeLink.textContent = isSignUpMode ? 'ログイン' : '新規登録';
    });

    logoutButton.addEventListener('click', async () => {
        console.log('[Auth] Attempting to sign out.');
        const { error } = await supabaseClient.auth.signOut();
        if (error) {
            console.error('[Auth] Sign out error:', error.message);
        } else {
            console.log('[Auth] Sign out successful.');
        }
    });


    // ===== CORE TOOL LOGIC =====
    function initializeAppLogic() {
        console.log('[App Logic] Initializing...');
        
        // --- Application State ---
        const appState = {
            activeTab: 'methodology',
            activeSubTab: 'theory',
            activeCaseKey: null,
            commonInputs: {
                totalCustomers: 150000,
                kValue: 0.5,
            },
            singleBrand: {
                results: null,
                period: 'annual',
            },
            simulation: {
                targetType: 'buyers',
                results: null,
                period: 'annual',
            },
            timeSeries: {
                data: [],
                aiContext: { industry: '', target: '', context: '' }
            },
            caseStudies: [
                { 
                    key: 'gym', 
                    title: '事例1: 24時間フィットネスジム (神戸市中央区)', 
                    description: '市場を地域のアクティブ層に絞り、会員の現実的な利用実態を反映した事例。', 
                    totalCustomers: 30000, 
                    kValue: 0.8, 
                    brandDataAnnual: { buyers: 900, purchases: 9000 }, 
                    brandDataMonthly: { buyers: 700, purchases: 700 },
                    simDataAnnual: { baseBuyers: 900, baseFrequency: 10.0, avgProfit: 2400 },
                    simDataMonthly: { baseBuyers: 700, baseFrequency: 1.0, avgProfit: 2400 },
                    simTargetDataAnnual: { buyers: 990, penetration: 3.3, frequency: 9.8 },
                    simTargetDataMonthly: { buyers: 735, penetration: 2.45, frequency: 1.0 },
                    aiContext: { industry: 'フィットネスジム（24時間営業）', products: '月額制フィットネスプラン（8,000円/月）', target: '20代〜40代の会社員、地域の健康意識が高い住民', strengths: '24時間いつでも利用可能、最新マシン導入、駅からのアクセス良好', simContext: '競合の増加により、新規顧客獲得の単価を抑えつつ効果的な施策を探している。' },
                    timeSeriesData: [
                        { period: '2024-Q1', buyers: 850, purchases: 8300, events: '新規オープンキャンペーン' },
                        { period: '2024-Q2', buyers: 900, purchases: 9000, events: 'Web広告開始' },
                        { period: '2024-Q3', buyers: 920, purchases: 9500, events: '紹介キャンペーン実施' },
                        { period: '2024-Q4', buyers: 950, purchases: 10500, events: '年末入会金無料キャンペーン' }
                    ]
                },
                { 
                    key: 'kaitori', 
                    title: '事例2: 中古ブランド品買取店 (オンライン＋店舗)', 
                    description: 'ターゲット層をより関心の高い層に絞り、非日常的な利用頻度を反映した事例。', 
                    totalCustomers: 150000, 
                    kValue: 1.2, 
                    brandDataAnnual: { buyers: 4500, purchases: 5850 }, 
                    brandDataMonthly: { buyers: 500, purchases: 550 },
                    simDataAnnual: { baseBuyers: 4500, baseFrequency: 1.3, avgProfit: 20000 },
                    simDataMonthly: { baseBuyers: 500, baseFrequency: 1.1, avgProfit: 20000 },
                    simTargetDataAnnual: { buyers: 4725, penetration: 3.15, frequency: 1.28 },
                    simTargetDataMonthly: { buyers: 525, penetration: 0.35, frequency: 1.08 },
                    aiContext: { industry: '中古品買取（ブランド品）', products: 'ブランドバッグ、時計、貴金属の買取', target: '30代〜50代の女性、終活・断捨離を考えている層', strengths: 'LINEでの簡単査定、経験豊富な鑑定士による丁寧な接客', simContext: 'Web広告の費用対効果を最大化する目標を設定したい。'},
                    timeSeriesData: [
                        { period: '前期', buyers: 4200, purchases: 5400, events: 'リスティング広告中心' },
                        { period: '今期', buyers: 4500, purchases: 5850, events: 'インフルエンサー施策追加' }
                    ]
                },
                { 
                    key: 'realestate', 
                    title: '事例3: 不動産仲介（売買） (西宮市)', 
                    description: '市場を「取引可能性の高い層」に再定義し、低い利用頻度と高い利益性を反映した事例。', 
                    totalCustomers: 4000, 
                    kValue: 0.5, 
                    brandDataAnnual: { buyers: 60, purchases: 66 }, 
                    brandDataMonthly: { buyers: 5, purchases: 5 },
                    simDataAnnual: { baseBuyers: 60, baseFrequency: 1.1, avgProfit: 600000 },
                    simDataMonthly: { baseBuyers: 5, baseFrequency: 1.0, avgProfit: 600000 },
                    simTargetDataAnnual: { buyers: 66, penetration: 1.65, frequency: 1.08 },
                    simTargetDataMonthly: { buyers: 6, penetration: 0.15, frequency: 1.0 },
                    aiContext: { industry: '不動産仲介（売買）', products: '中古マンション、戸建ての売買仲介', target: '30代〜40代のファミリー層、資産売却を考えるシニア層', strengths: '地域情報に精通、売却査定の精度が高い、住宅ローン相談に強い', simContext: '売却物件の獲得数を増やしたいが、安易な手数料競争は避けたい。' },
                    timeSeriesData: [
                        { period: '2022年', buyers: 55, purchases: 60, events: '従来通りの営業活動' },
                        { period: '2023年', buyers: 60, purchases: 66, events: 'Webサイトリニューアル、ブログ強化' }
                    ]
                },
                { 
                    key: 'juku', 
                    title: '事例4: 学習塾（高校生向け） (枚方市)', 
                    description: '市場を大学進学希望者に絞り、「購入＝月謝支払」と定義した事例。', 
                    totalCustomers: 5000, 
                    kValue: 0.6, 
                    brandDataAnnual: { buyers: 150, purchases: 1500 },
                    brandDataMonthly: { buyers: 120, purchases: 120 },
                    simDataAnnual: { baseBuyers: 150, baseFrequency: 10, avgProfit: 15000 },
                    simDataMonthly: { baseBuyers: 120, baseFrequency: 1, avgProfit: 15000 },
                    simTargetDataAnnual: { buyers: 165, penetration: 3.3, frequency: 9.9 },
                    simTargetDataMonthly: { buyers: 126, penetration: 2.52, frequency: 1.0 },
                    aiContext: { industry: '学習塾（大学受験）', products: '集団授業（英語・数学）、個別指導、進路相談', target: '大学進学を目指す高校1〜3年生とその保護者', strengths: '地域トップ校への高い合格実績、卒業生チューターによる手厚いサポート', simContext: '少子化を見据え、生徒一人あたりのLTV向上も視野に入れたい。' },
                    timeSeriesData: [
                        { period: '1学期', buyers: 110, purchases: 330, events: '新年度募集' },
                        { period: '夏期講習', buyers: 130, purchases: 130, events: '夏期集中講座' },
                        { period: '2学期', buyers: 120, purchases: 480, events: '通常授業' },
                        { period: '冬期講習', buyers: 125, purchases: 250, events: '冬期・直前講習' }
                    ]
                },
                { 
                    key: 'pachinko_kansai', 
                    title: '事例5: パチンコホール (関西・郊外型)', 
                    description: '市場を遊技経験者に絞り、ファン中心の高い来店頻度を想定した事例。', 
                    totalCustomers: 50000, 
                    kValue: 0.3, 
                    brandDataAnnual: { buyers: 3000, purchases: 60000 },
                    brandDataMonthly: { buyers: 1000, purchases: 4000 },
                    simDataAnnual: { baseBuyers: 3000, baseFrequency: 20, avgProfit: 2500 },
                    simDataMonthly: { baseBuyers: 1000, baseFrequency: 4, avgProfit: 2500 },
                    simTargetDataAnnual: { buyers: 3150, penetration: 6.3, frequency: 19.8 },
                    simTargetDataMonthly: { buyers: 1050, penetration: 2.1, frequency: 3.96 },
                    aiContext: { industry: 'パチンコホール（郊外型）', products: '4円パチンコ, 1円パチンコ, 20円スロット', target: '30代〜60代の地域住民、車での来店者が中心', strengths: '広い駐車場、機種ラインナップのバランス、常連客とのコミュニケーション', simContext: '若年層のパチンコ離れが進む中、新規ファンの獲得が急務。' },
                     timeSeriesData: [
                        { period: '1月', buyers: 1100, purchases: 4200, events: '新台入替' },
                        { period: '2月', buyers: 950, purchases: 3800, events: '通常営業' },
                        { period: '3月', buyers: 1200, purchases: 4500, events: '周年イベント' }
                    ]
                },
                { 
                    key: 'pachinko_kanto', 
                    title: '事例6: パチンコホール (関東・駅前型)', 
                    description: 'ライトユーザーが多い駅前店の特性を反映し、顧客母数は多いが来店頻度は低めのモデル。', 
                    totalCustomers: 150000, 
                    kValue: 1.0, 
                    brandDataAnnual: { buyers: 9000, purchases: 90000 },
                    brandDataMonthly: { buyers: 3000, purchases: 6000 },
                    simDataAnnual: { baseBuyers: 9000, baseFrequency: 10, avgProfit: 3000 },
                    simDataMonthly: { baseBuyers: 3000, baseFrequency: 2, avgProfit: 3000 },
                    simTargetDataAnnual: { buyers: 9450, penetration: 6.3, frequency: 9.9 },
                    simTargetDataMonthly: { buyers: 3150, penetration: 2.1, frequency: 1.98 },
                    aiContext: { industry: 'パチンコホール（駅前型）', products: '最新機種中心の4円パチンコ, 20円スロット, 加熱式たばこプレイエリア', target: '20代〜40代の会社員・学生、電車での来店者が中心', strengths: '駅直結の好立地、新台入替の速さ、豊富な景品', simContext: '競合との差別化を図り、ライトユーザーの再来店頻度を向上させたい。' },
                    timeSeriesData: [
                        { period: '平日', buyers: 5000, purchases: 8000, events: '通常営業' },
                        { period: '休日', buyers: 7000, purchases: 12000, events: '休日営業' }
                    ]
                }
            ],
            industryGuides: [
                { title: "24時間フィットネスジム", data: [ { metric: '① 市場の総顧客数', examples: ['[地理] 店舗から半径3km圏内の総人口（自治体の統計データ）', '[人口動態] 商圏エリアの20〜50代の人口（よりターゲットに近い）', '[行動] 近隣の主要駅の1日平均乗降客数（通勤・通学者も含む）'] }, { metric: '② 購入者数 (会員数)', examples: ['[基本] 過去1年間のアクティブ会員のユニークな人数（会員管理システム）', '[広義] 過去1年間のビジター利用も含めた、重複を除いた総利用者数'] }, { metric: '③ 総購入回数 (利用回数)', examples: ['[月額課金] 年間で発生した月謝支払いの延べ回数（例: 500人×12ヶ月 = 6,000回）', '[実利用] 全会員の年間チェックイン（入館）回数の合計', '[オプション含] 月謝＋パーソナルトレーニングや物販の総利用件数'] } ] },
                { title: "中古品買取店", data: [ { metric: '① 市場の総顧客数', examples: ['[地理] 店舗の商圏エリアの総世帯数（1世帯=1顧客と考える）', '[人口動態] ターゲット層（例：30〜60代女性）の人口', '[Web] 「地域名 買取」「ブランド名 買取」などの月間検索ボリューム合計'] }, { metric: '② 購入者数 (買取成立顧客数)', examples: ['[基本] 過去1年間に買取が成立した顧客のユニークな人数', '[見込み客] LINE査定や店頭査定を依頼した人のユニークな人数'] }, { metric: '③ 総購入回数 (買取成立件数)', examples: ['[基本] 過去1年間の総買取伝票の枚数', '[実態] 1人の顧客が複数回売りに来た場合もすべてカウントした延べ件数'] } ] },
                { title: "不動産仲介（売買）", data: [ { metric: '① 市場の総顧客数', examples: ['[地理] 担当エリアの総世帯数', '[取引ベース] 過去1年間のエリア内の不動産売買の総成立件数（レインズ等から推計）', '[潜在層] 担当エリアの持ち家世帯数（売却の可能性）＋賃貸世帯数（購入の可能性）'] }, { metric: '② 購入者数 (契約顧客数)', examples: ['[基本] 年間に売買仲介契約を結んだ顧客（売主・買主）のユニークな人数', '[売主] 専任媒介契約を獲得した売主の人数'] }, { metric: '③ 総購入回数 (契約件数)', examples: ['[基本] 年間の売買仲介の総契約件数', '[両手・片手含] 売主からの契約と買主からの契約をそれぞれ1件とカウントした延べ件数'] } ] },
                { title: "学習塾", data: [ { metric: '① 市場の総顧客数', examples: ['[地理] 担当エリアのターゲット学年（例：小学生）の総生徒数', '[学校単位] 主な集客源となっている近隣小・中学校の全校生徒数の合計'] }, { metric: '② 購入者数 (在籍生徒数)', examples: ['[基本] 年度末時点での正規の在籍生徒の実人数', '[広義] 体験授業や季節講習のみの参加者も含めた、年間のユニークな受講生徒数'] }, { metric: '③ 総購入回数 (受講回数)', examples: ['[月謝ベース] 全生徒の月謝の支払い延べ回数（例: 100人×12ヶ月=1200回）', '[授業ベース] 全生徒の年間総受講コマ数の合計', '[イベント含] 月謝＋夏期・冬期講習の総申込件数の合計'] } ] },
                { title: "パチンコホール", data: [ { metric: '① 市場の総顧客数', examples: [ '[地理] 店舗から半径5km圏内の20歳以上人口（自治体の統計データ）', '[行動] 近隣の主要駅の1日平均乗降客数（駅前店の場合）', '[Web] P-WORLDなどポータルサイトのエリア内登録者数' ]}, { metric: '② 購入者数 (来店客数)', examples: [ '[基本] 年間のユニークな会員カード利用者数', '[広義] 顔認証システムなどから推定される、重複を除いた総来店者数', '[見込み] LINE友だち登録者数やメールマガジン会員数' ]}, { metric: '③ 総購入回数 (総来店回数)', examples: [ '[実利用] 全顧客の年間総来店回数の合計', '[時間ベース] 全遊技台の年間総稼働時間' ]} ] },
            ]
        };

        // --- Calculation Utilities ---
        const gamma = (z) => {
            const p = [676.5203681218851, -1259.1392167224028, 771.32342877765313, -176.61502916214059, 12.507343278686905, -0.13857109526572012, 9.9843695780195716e-6, 1.5056327351493116e-7];
            if (z < 0.5) return Math.PI / (Math.sin(Math.PI * z) * gamma(1 - z));
            z -= 1; let x = 0.99999999999980993;
            for (let i = 0; i < p.length; i++) x += p[i] / (z + i + 1);
            const t = z + p.length - 0.5;
            return Math.sqrt(2 * Math.PI) * Math.pow(t, z + 0.5) * Math.exp(-t) * x;
        };
        const factorial = (n) => {
            if (n < 0) return NaN; if (n === 0 || n === 1) return 1;
            let result = 1; for (let i = 2; i <= n; i++) result *= i; return result;
        };
        const nbdProbability = (r, m, k) => {
            if (k <= 0 || m < 0 || r < 0) return 0;
            try {
                const term1 = gamma(k + r) / (gamma(k) * factorial(r));
                const term2 = Math.pow(k / (m + k), k);
                const term3 = Math.pow(m / (m + k), r);
                return term1 * term2 * term3;
            } catch (error) { return 0; }
        };
        
        // --- UI Helpers ---
        const formatAiReport = (text) => {
            return text
                .replace(/###\s*(.*?)\n/g, '<h3>$1</h3>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/-\s(.*?)\n/g, '<li>$1</li>')
                .replace(/(<\/li>)\s*<li>/g, '$1<li>')
                .replace(/\n/g, '<br>');
        };
        
        // --- Navigation ---
        const tabButtons = document.querySelectorAll('.tab-button');
        const contentPanels = document.querySelectorAll('.content-panel');
        const commonInputsContainer = document.getElementById('common-inputs-container');

        const switchTab = (tabId) => {
            appState.activeTab = tabId;
            tabButtons.forEach(button => {
                const isSelected = button.dataset.tab === tabId;
                button.classList.toggle('bg-blue-600', isSelected);
                button.classList.toggle('text-white', isSelected);
                button.classList.toggle('shadow-lg', isSelected);
                button.classList.toggle('scale-105', isSelected);
                button.classList.toggle('bg-white', !isSelected);
                button.classList.toggle('text-gray-700', !isSelected);
            });
            contentPanels.forEach(panel => {
                panel.style.display = panel.id === `${tabId}-content` ? 'block' : 'none';
            });
            commonInputsContainer.style.display = ['methodology', 'howToUse'].includes(tabId) ? 'none' : 'block';
            if (tabId === 'timeseries' && appState.timeSeries.data.length > 0) {
                 renderTimeSeriesResults();
            }
            lucide.createIcons();
        };

        tabButtons.forEach(button => button.addEventListener('click', () => switchTab(button.dataset.tab)));

        const theorySubtabButton = document.getElementById('theory-subtab-button');
        const guideSubtabButton = document.getElementById('guide-subtab-button');
        const theorySubtabContent = document.getElementById('theory-subtab-content');
        const guideSubtabContent = document.getElementById('guide-subtab-content');

        const switchSubTab = (subTabId) => {
            appState.activeSubTab = subTabId;
            const isTheory = subTabId === 'theory';
            theorySubtabButton.classList.toggle('border-blue-500', isTheory);
            theorySubtabButton.classList.toggle('text-blue-600', isTheory);
            theorySubtabButton.classList.toggle('border-transparent', !isTheory);
            theorySubtabButton.classList.toggle('text-gray-500', !isTheory);
            guideSubtabButton.classList.toggle('border-blue-500', !isTheory);
            guideSubtabButton.classList.toggle('text-blue-600', !isTheory);
            guideSubtabButton.classList.toggle('border-transparent', isTheory);
            guideSubtabButton.classList.toggle('text-gray-500', isTheory);
            theorySubtabContent.style.display = isTheory ? 'block' : 'none';
            guideSubtabContent.style.display = isTheory ? 'none' : 'block';
        };
        theorySubtabButton.addEventListener('click', () => switchSubTab('theory'));
        guideSubtabButton.addEventListener('click', () => switchSubTab('guide'));

        // --- Common Inputs ---
        const totalCustomersInput = document.getElementById('total-customers-input');
        const kValueInput = document.getElementById('k-value-input');
        const kValueDisplay = document.getElementById('k-value-display');

        totalCustomersInput.addEventListener('input', () => {
            appState.commonInputs.totalCustomers = Number(totalCustomersInput.value) || 0;
            appState.activeCaseKey = null;
            if(appState.activeTab === 'timeseries') renderTimeSeriesResults();
        });
        kValueInput.addEventListener('input', () => {
            const value = Number(kValueInput.value);
            appState.commonInputs.kValue = value;
            kValueDisplay.textContent = value.toFixed(2);
            appState.activeCaseKey = null;
        });

        // --- Gemini API Call (MODIFIED for Supabase Edge Functions) ---
        const callGeminiAPI = async (prompt, reportElement, buttonElement) => {
            console.log(`%c[API Call] Starting Gemini API call via Supabase Edge Function.`, 'color: blue');
            const originalButtonContent = buttonElement.innerHTML;
            buttonElement.innerHTML = `<i data-lucide="loader-2" class="animate-spin h-5 w-5 mr-2"></i> 分析中...`;
            lucide.createIcons();
            buttonElement.disabled = true;
            reportElement.innerHTML = ''; 

            try {
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }]
                };
                console.log('[API Call] Invoking "call-gemini" function.');
                
                const { data, error } = await supabaseClient.functions.invoke('call-gemini', {
                    body: payload,
                });

                if (error) {
                    throw error;
                }

                console.log('[API Call] Successfully received response from Edge Function.');
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (text) {
                    reportElement.innerHTML = formatAiReport(text);
                    console.log('[API Call] Report generated and displayed successfully.');
                } else {
                    console.error('[API Call] Error: Response format from Gemini was invalid.', data);
                    reportElement.innerHTML = "<p>AIからのアドバイスを生成できませんでした。予期せぬレスポンス形式です。</p>";
                }
            } catch (e) {
                console.error("[API Call] Supabase Edge Function invocation failed:", e);
                reportElement.innerHTML = `<p>AIからのアドバイス生成中にエラーが発生しました。<br>${e.message}</p>`;
            } finally {
                buttonElement.innerHTML = originalButtonContent;
                lucide.createIcons();
                buttonElement.disabled = false;
            }
        };

        // --- Single Brand Analysis ---
        const singleTotalPurchasesInput = document.getElementById('single-total-purchases');
        const singleBrandBuyersInput = document.getElementById('single-brand-buyers');
        const singleAnalyzeButton = document.getElementById('single-analyze-button');
        const singleAiButton = document.getElementById('single-ai-button');
        const singleResultsContainer = document.getElementById('single-results-container');
        const singleError = document.getElementById('single-error');
        const singlePeriodAnnualBtn = document.getElementById('single-period-annual');
        const singlePeriodMonthlyBtn = document.getElementById('single-period-monthly');
        const singlePurchasesLabel = document.getElementById('single-purchases-label');
        const singleBuyersLabel = document.getElementById('single-buyers-label');
        
        [singleTotalPurchasesInput, singleBrandBuyersInput].forEach(input => {
            input.addEventListener('input', () => { appState.activeCaseKey = null; });
        });

        const singleAiIndustry = document.getElementById('single-ai-industry');
        const singleAiProducts = document.getElementById('single-ai-products');
        const singleAiTarget = document.getElementById('single-ai-target');
        const singleAiStrengths = document.getElementById('single-ai-strengths');

        const handleSinglePeriodChange = (period) => {
            appState.singleBrand.period = period;
            const periodText = period === 'annual' ? '年間' : '月間';
            singlePurchasesLabel.textContent = `${periodText}の総購入回数`;
            singleBuyersLabel.textContent = `${periodText}の購入者数`;
            const isAnnual = period === 'annual';
            singlePeriodAnnualBtn.classList.toggle('bg-blue-600', isAnnual);
            singlePeriodAnnualBtn.classList.toggle('text-white', isAnnual);
            singlePeriodMonthlyBtn.classList.toggle('bg-blue-600', !isAnnual);
            singlePeriodMonthlyBtn.classList.toggle('text-white', !isAnnual);
            singlePeriodMonthlyBtn.classList.toggle('bg-white', isAnnual);
            singlePeriodAnnualBtn.classList.toggle('bg-white', !isAnnual);

            if (appState.activeCaseKey) {
                const data = appState.caseStudies.find(c => c.key === appState.activeCaseKey);
                if (data) {
                    const brandData = isAnnual ? data.brandDataAnnual : data.brandDataMonthly;
                    singleTotalPurchasesInput.value = brandData.purchases;
                    singleBrandBuyersInput.value = brandData.buyers;
                }
            }
        };

        singlePeriodAnnualBtn.addEventListener('click', () => handleSinglePeriodChange('annual'));
        singlePeriodMonthlyBtn.addEventListener('click', () => handleSinglePeriodChange('monthly'));

        const calculateSingleBrand = () => {
            const { totalCustomers, kValue } = appState.commonInputs;
            const totalPurchases = Number(singleTotalPurchasesInput.value);
            const brandBuyers = Number(singleBrandBuyersInput.value);

            if (!totalCustomers || !totalPurchases || !brandBuyers || totalCustomers <= 0 || totalPurchases <= 0 || brandBuyers <= 0) {
                return { error: 'すべての入力欄に0より大きい数値を入力してください。' };
            }
            if (brandBuyers > totalCustomers) {
                return { error: '購入者数は総顧客数以下である必要があります。' };
            }
            const penetration = brandBuyers / totalCustomers;
            const avgFrequency = totalPurchases / brandBuyers;
            const preferenceScore = (totalPurchases / totalCustomers) * 1000;
            
            const distribution = Array.from({ length: 21 }, (_, r) => ({
                purchases: r,
                customers: Math.round(nbdProbability(r, avgFrequency, kValue) * brandBuyers),
            }));
            return { error: null, penetration, avgFrequency, preferenceScore, distribution };
        };

        const renderSingleBrandResults = () => {
            const { results, period } = appState.singleBrand;
            if (!results) {
                singleResultsContainer.innerHTML = `<p class="text-gray-500 flex items-center justify-center h-full min-h-[400px]">データを入力して「分析実行」を押してください。</p>`;
                return;
            }

            const maxValue = Math.max(...results.distribution.map(item => item.customers));
            const chartBarsHtml = results.distribution.map(item => {
                const heightPercentage = maxValue > 0 ? (item.customers / maxValue) * 100 : 0;
                return `
                    <div class="flex flex-col items-center justify-end h-full group relative" style="width: 4%;">
                        <div class="bg-blue-500 hover:bg-blue-700 transition-colors w-full" style="height: ${heightPercentage}%;">
                            <div class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 w-max p-2 bg-gray-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                                ${item.purchases}回購入: ${item.customers.toLocaleString()}人
                            </div>
                        </div>
                        <span class="text-xs mt-1">${item.purchases}</span>
                    </div>
                `;
            }).join('');

            singleResultsContainer.innerHTML = `
                <div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                        <div class="p-4 rounded-xl shadow-md bg-purple-100 text-purple-900">
                            <div class="flex items-center justify-between">
                                 <p class="text-sm font-medium opacity-80">プレファレンススコア</p>
                                 <div class="tooltip-container">
                                    <i data-lucide="help-circle" class="text-purple-400" style="width: 16px; height: 16px;"></i>
                                    <div class="tooltip-content"><b>計算式:</b><br>(総購入回数 ÷ 市場総顧客数) × 1,000</div>
                                </div>
                            </div>
                            <p class="text-2xl lg:text-3xl font-bold">${results.preferenceScore.toFixed(0)}</p>
                        </div>
                        <div class="p-4 rounded-xl shadow-md bg-blue-100 text-blue-900">
                            <div class="flex items-center justify-between">
                                <p class="text-sm font-medium opacity-80">浸透率 (P)</p>
                                <div class="tooltip-container">
                                    <i data-lucide="help-circle" class="text-blue-400" style="width: 16px; height: 16px;"></i>
                                    <div class="tooltip-content"><b>計算式:</b><br>購入者数 ÷ 市場の総顧客数</div>
                                </div>
                            </div>
                            <p class="text-2xl lg:text-3xl font-bold">${(results.penetration * 100).toFixed(2)}<span class="text-base font-normal ml-1">%</span></p>
                        </div>
                        <div class="p-4 rounded-xl shadow-md bg-green-100 text-green-900">
                            <div class="flex items-center justify-between">
                                <p class="text-sm font-medium opacity-80">平均購入回数 (F)</p>
                                <div class="tooltip-container">
                                    <i data-lucide="help-circle" class="text-green-400" style="width: 16px; height: 16px;"></i>
                                    <div class="tooltip-content"><b>計算式:</b><br>総購入回数 ÷ 購入者数</div>
                                </div>
                            </div>
                            <p class="text-2xl lg:text-3xl font-bold">${results.avgFrequency.toFixed(2)}<span class="text-base font-normal ml-1">回</span></p>
                        </div>
                    </div>
                    <h4 class="text-lg font-semibold mb-2">顧客構造の可視化</h4>
                    <div class="w-full h-[300px] bg-white p-4 pl-10 border rounded-lg">
                        <div class="flex items-end h-full justify-around border-l border-b border-gray-300 relative">
                            <div class="absolute -left-8 top-0 bottom-0 flex flex-col justify-between text-xs text-gray-500"><span>${maxValue > 0 ? maxValue.toLocaleString() : ''}</span><span>${maxValue > 0 ? Math.round(maxValue/2).toLocaleString() : ''}</span><span>0</span></div>
                            ${chartBarsHtml}
                        </div>
                        <p class="text-center text-sm text-gray-600 mt-2">購入回数（${period === 'annual' ? '年間' : '月間'}）</p>
                    </div>
                    <div class="mt-8">
                        <h3 class="text-xl font-semibold mb-4 border-b pb-3 flex items-center"><i data-lucide="bot" class="h-6 w-6 mr-2 text-indigo-500"></i> AIコンサルタントの戦略レポート</h3>
                        <div id="single-ai-report" class="prose"></div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        };

        singleAnalyzeButton.addEventListener('click', () => {
            singleError.style.display = 'none';
            const res = calculateSingleBrand();
            if (res.error) {
                singleError.textContent = res.error;
                singleError.style.display = 'block';
                appState.singleBrand.results = null;
                singleAiButton.disabled = true;
            } else {
                appState.singleBrand.results = res;
                singleAiButton.disabled = false;
            }
            renderSingleBrandResults();
        });
        
        singleAiButton.addEventListener('click', () => {
    const { results, period } = appState.singleBrand;
    if (!results) return;

    const prompt = `あなたは、データに基づいた提案を得意とする経営コンサルタントです。クライアント（広告会社の営業担当者）が、その先の顧客に提案するための、分かりやすく実行可能な戦略レポートを作成してください。

# クライアントの基本情報
- 業種: ${singleAiIndustry.value || '指定なし'}
- 主な商品: ${singleAiProducts.value || '指定なし'}
- ターゲット顧客: ${singleAiTarget.value || '指定なし'}
- 自社の強み: ${singleAiStrengths.value || '指定なし'}

# 分析データ (${period === 'annual' ? '年間' : '月間'})
- プレファレンススコア: ${results.preferenceScore.toFixed(0)} (市場1,000人あたりの総購入回数)
- 浸透率 (P): ${(results.penetration * 100).toFixed(3)}% (市場内での存在感)
- 平均購入回数 (F): ${results.avgFrequency.toFixed(2)}回 (購入者の熱量)

# 指示
上記の情報を総合的に判断し、以下の三部構成で、提案書としてそのまま使えるレベルの戦略レポートを生成してください。余計な挨拶や締め言葉は一切不要です。

### Part 1: 現状の診断サマリー
提供された「クライアントの基本情報」と「分析データ」を基に、このビジネスの現状を客観的に診断してください。以下の3つの要素を必ず含めてください。
- **考えられる強み:** クライアントが認識している「自社の強み」と、データから読み取れる長所を組み合わせて記述してください。
- **考えられる弱み:** データ（特に浸透率や平均購入回数）から推測される課題点を指摘してください。
- **3つの指標の関係性から見えること:** プレファレンススコア、浸透率(P)、平均購入回数(F)のバランスを見て、ビジネスがどのような状態にあるかを専門的に解説してください。（例：「商品の魅力でファンを掴めているが、その魅力が市場全体に伝わりきっていない状態」など）

### Part 2: 具体的なアクションプラン
上記の診断結果とクライアントの強みを踏まえ、最重要指標である「プレファレンススコア」を向上させるための、明日からでも実行可能な具体的なアクションを5つ以上提案してください。「誰に」「何を」「どのように」が明確に分かるように、詳細に記述してください。

### Part 3: 成功を測るための主要KPI
提案したアクションプランが成功しているかを判断するための、具体的な数値目標（KPI）を例として5つ以上設定してください。必ず「現状の数値 → 目標の数値（X.X倍増など）」という形式で示し、可能であれば計測方法も補足してください。
`;
    const reportElement = document.getElementById('single-ai-report');
    callGeminiAPI(prompt, reportElement, singleAiButton);
});
        
        // --- Strategy Simulation ---
        const simPeriodAnnualBtn = document.getElementById('sim-period-annual');
        const simPeriodMonthlyBtn = document.getElementById('sim-period-monthly');
        const simBaseBuyersInput = document.getElementById('sim-base-buyers');
        const simBaseFrequencyInput = document.getElementById('sim-base-frequency');
        const simTargetTypeRadios = document.querySelectorAll('input[name="simTargetType"]');
        const simTargetInputs = {
            penetration: document.getElementById('sim-target-penetration-input'),
            buyers: document.getElementById('sim-target-buyers-input'),
            frequency: document.getElementById('sim-target-frequency-input'),
        };
        const simAvgProfitInput = document.getElementById('sim-avg-profit');
        const simBudgetInput = document.getElementById('sim-budget');
        const simRunButton = document.getElementById('sim-run-button');
        const simAiButton = document.getElementById('sim-ai-button');
        const simResultsContainer = document.getElementById('sim-results-container');
        const simBuyersLabel = document.getElementById('sim-buyers-label');
        const simFreqLabel = document.getElementById('sim-freq-label');
        
        [simBaseBuyersInput, simBaseFrequencyInput, simAvgProfitInput, simBudgetInput].forEach(input => {
            input.addEventListener('input', () => { appState.activeCaseKey = null; });
        });
        
        const simAiIndustry = document.getElementById('sim-ai-industry');
        const simAiTarget = document.getElementById('sim-ai-target');
        const simAiStrengths = document.getElementById('sim-ai-strengths');
        const simAiContext = document.getElementById('sim-ai-context');

        const handleSimPeriodChange = (period) => {
            appState.simulation.period = period;
            const periodText = period === 'annual' ? '年間' : '月間';
            simBuyersLabel.textContent = `${periodText}の購入者数`;
            simFreqLabel.textContent = `${periodText}の平均購入回数`;
            const isAnnual = period === 'annual';
            simPeriodAnnualBtn.classList.toggle('bg-blue-600', isAnnual);
            simPeriodAnnualBtn.classList.toggle('text-white', isAnnual);
            simPeriodMonthlyBtn.classList.toggle('bg-blue-600', !isAnnual);
            simPeriodMonthlyBtn.classList.toggle('text-white', !isAnnual);
            simPeriodMonthlyBtn.classList.toggle('bg-white', isAnnual);
            simPeriodAnnualBtn.classList.toggle('bg-white', !isAnnual);

            if (appState.activeCaseKey) {
                const data = appState.caseStudies.find(c => c.key === appState.activeCaseKey);
                if (data) {
                    const simData = isAnnual ? data.simDataAnnual : data.simDataMonthly;
                    const simTargetData = isAnnual ? data.simTargetDataAnnual : data.simTargetDataMonthly;
                    simBaseBuyersInput.value = simData.baseBuyers;
                    simBaseFrequencyInput.value = simData.baseFrequency;
                    simAvgProfitInput.value = simData.avgProfit;
                    document.getElementById('sim-target-buyers').value = simTargetData.buyers;
                    document.getElementById('sim-target-penetration').value = simTargetData.penetration;
                    document.getElementById('sim-target-frequency').value = simTargetData.frequency;
                }
            }

            if (appState.simulation.results) {
                simRunButton.click();
            }
        };
        simPeriodAnnualBtn.addEventListener('click', () => handleSimPeriodChange('annual'));
        simPeriodMonthlyBtn.addEventListener('click', () => handleSimPeriodChange('monthly'));

        simTargetTypeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                const type = e.target.value;
                appState.simulation.targetType = type;
                Object.values(simTargetInputs).forEach(input => input.style.display = 'none');
                simTargetInputs[type].style.display = 'block';
            });
        });

        const runSimulation = () => {
            const { totalCustomers } = appState.commonInputs;
            const baseBuyers = Number(simBaseBuyersInput.value);
            const baseFrequency = Number(simBaseFrequencyInput.value);
            
            if (totalCustomers <= 0 || baseBuyers < 0 || baseFrequency < 0) return null;

            const basePenetration = baseBuyers > 0 ? baseBuyers / totalCustomers : 0;
            const baseTotalPurchases = baseBuyers * baseFrequency;
            const basePreferenceScore = baseTotalPurchases > 0 ? (baseTotalPurchases / totalCustomers) * 1000 : 0;

            let target = {};
            const { targetType } = appState.simulation;

            if (targetType === 'penetration') {
                const newPenetration = Number(document.getElementById('sim-target-penetration').value) / 100;
                if(newPenetration < 0) return null;
                target.buyers = totalCustomers * newPenetration;
                const penetrationRatio = basePenetration > 0 ? newPenetration / basePenetration : 0;
                target.frequency = penetrationRatio > 0 ? baseFrequency / Math.sqrt(penetrationRatio) : baseFrequency;
            } else if (targetType === 'buyers') {
                target.buyers = Number(document.getElementById('sim-target-buyers').value);
                if(target.buyers < 0) return null;
                const newPenetration = target.buyers > 0 ? target.buyers / totalCustomers : 0;
                if(basePenetration <= 0) {
                     target.frequency = baseFrequency > 0 ? baseFrequency : 1;
                } else {
                    const penetrationRatio = newPenetration / basePenetration;
                    target.frequency = penetrationRatio > 0 ? baseFrequency / Math.sqrt(penetrationRatio) : baseFrequency;
                }
            } else { // frequency
                target.frequency = Number(document.getElementById('sim-target-frequency').value);
                if(target.frequency < 0) return null;
                const penetrationRatio = baseFrequency > 0 ? Math.pow(baseFrequency / target.frequency, 2) : 0;
                target.buyers = basePenetration > 0 ? totalCustomers * (basePenetration * penetrationRatio) : baseBuyers;
            }
            
            target.penetration = target.buyers > 0 ? target.buyers / totalCustomers : 0;
            target.totalPurchases = target.buyers * target.frequency;
            target.preferenceScore = target.totalPurchases > 0 ? (target.totalPurchases / totalCustomers) * 1000 : 0;

            return {
                base: { preferenceScore: basePreferenceScore, penetration: basePenetration, buyers: baseBuyers, frequency: baseFrequency, totalPurchases: baseTotalPurchases },
                target
            };
        };
        
        const renderSimulationResults = () => {
            const { results, period } = appState.simulation;
            if (!results) {
                simResultsContainer.innerHTML = `<p class="text-gray-500 flex items-center justify-center h-full min-h-[400px]">現状と目標を入力して、「シミュレーション実行」を押してください。</p>`;
                return;
            }

            const avgProfit = Number(simAvgProfitInput.value) || 0;
            const budget = Number(simBudgetInput.value) || 0;
            const periodText = period === 'annual' ? '年間' : '月間';

            const baseProfit = results.base.totalPurchases * avgProfit;
            const targetProfit = results.target.totalPurchases * avgProfit;
            const profitChange = targetProfit - baseProfit;
            const roi = budget > 0 ? (profitChange / budget) * 100 : Infinity;
            
            const getSimChangeTooltip = (title) => {
                switch (title) {
                    case 'プレファレンススコア':
                        return '<b>計算式:</b><br>(予測総購入回数 ÷ 市場総顧客数) × 1,000';
                    case '浸透率(P)':
                        return '<b>計算式:</b><br>予測購入者数 ÷ 市場総顧客数';
                    case '購入者数':
                        return '目標値として設定、または他の目標値から逆算されます。';
                    case '総購入回数':
                        return '<b>計算式:</b><br>予測購入者数 × 予測平均購入回数';
                    default:
                        return '計算式の説明';
                }
            };

            const createSummaryCard = (title, baseValue, targetValue, formatter) => {
                const change = targetValue - baseValue;
                const percentChange = baseValue !== 0 ? (change / baseValue) * 100 : Infinity;
                const colorClass = change >= 0 ? 'text-green-600' : 'text-red-600';
                const iconName = change >= 0 ? 'arrow-up' : 'arrow-down';
                return `
                    <div class="p-3 bg-gray-50 rounded-lg shadow-sm">
                        <div class="flex items-center justify-between">
                            <h4 class="text-sm font-semibold text-gray-600">${title}</h4>
                            <div class="tooltip-container">
                                <i data-lucide="help-circle" class="text-gray-400" style="width: 16px; height: 16px;"></i>
                                <div class="tooltip-content">${getSimChangeTooltip(title)}</div>
                            </div>
                        </div>
                        <p class="text-xl font-bold ${colorClass} flex items-center">
                            <i data-lucide="${iconName}" class="w-4 h-4 mr-1"></i>
                            ${isFinite(percentChange) ? `${percentChange > 0 ? '+' : ''}${percentChange.toFixed(1)}%` : '∞'}
                        </p>
                        <p class="text-xs text-gray-500 mt-1">
                            ${formatter(baseValue)} → ${formatter(targetValue)}
                        </p>
                    </div>
                `;
            };
            
            const createSummaryItem = (label, value, formatter, tooltipText) => `
                <div class="sim-result-item flex justify-between items-center">
                    <p>${label}: <span class="font-bold">${formatter(value)}</span></p>
                    ${tooltipText ? `
                    <div class="tooltip-container ml-2">
                        <i data-lucide="help-circle" class="text-gray-400" style="width: 16px; height: 16px;"></i>
                        <div class="tooltip-content" style="width: 250px;">${tooltipText}</div>
                    </div>
                    ` : ''}
                </div>`;
                
            const tooltips = {
                preferenceScore: '<b>計算式:</b><br>(総購入回数 ÷ 市場総顧客数) × 1,000',
                penetration: '<b>計算式:</b><br>購入者数 ÷ 市場総顧客数',
                buyers: '<b>計算式:</b><br>浸透率 × 市場総顧客数',
                frequency: '<b>計算式:</b><br>総購入回数 ÷ 購入者数',
                totalPurchases: '<b>計算式:</b><br>購入者数 × 平均購入回数'
            };

            simResultsContainer.innerHTML = `
                <div class="animate-fade-in">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <h4 class="font-bold text-lg mb-2 text-gray-600">現状 (As-Is)</h4>
                            <div class="space-y-2 p-4 bg-gray-100 rounded-lg">
                                ${createSummaryItem('プレファレンススコア', results.base.preferenceScore, v => v.toFixed(0), tooltips.preferenceScore)}
                                ${createSummaryItem('浸透率', results.base.penetration, v => `${(v * 100).toFixed(2)}%`, tooltips.penetration)}
                                ${createSummaryItem('購入者数', results.base.buyers, v => `${Math.round(v).toLocaleString()}人`, tooltips.buyers)}
                                ${createSummaryItem('平均購入回数', results.base.frequency, v => `${v.toFixed(2)}回`, tooltips.frequency)}
                                <div class="pt-2 border-t mt-2">
                                    ${createSummaryItem('総購入回数', results.base.totalPurchases, v => `${Math.round(v).toLocaleString()}回`, tooltips.totalPurchases)}
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-bold text-lg mb-2 text-green-600">予測 (To-Be)</h4>
                            <div class="space-y-2 p-4 bg-green-50 rounded-lg">
                                 ${createSummaryItem('プレファレンススコア', results.target.preferenceScore, v => v.toFixed(0), tooltips.preferenceScore)}
                                ${createSummaryItem('浸透率', results.target.penetration, v => `${(v * 100).toFixed(2)}%`, tooltips.penetration)}
                                ${createSummaryItem('購入者数', results.target.buyers, v => `${Math.round(v).toLocaleString()}人`, tooltips.buyers)}
                                ${createSummaryItem('平均購入回数', results.target.frequency, v => `${v.toFixed(2)}回`, tooltips.frequency)}
                                <div class="pt-2 border-t mt-2">
                                    ${createSummaryItem('総購入回数', results.target.totalPurchases, v => `${Math.round(v).toLocaleString()}回`, tooltips.totalPurchases)}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h4 class="font-bold text-lg mb-3 text-gray-800">目標達成による変化</h4>
                    <div class="grid grid-cols-2 lg:grid-cols-2 gap-4 mb-6">
                        ${createSummaryCard('プレファレンススコア', results.base.preferenceScore, results.target.preferenceScore, v => v.toFixed(0))}
                        ${createSummaryCard('浸透率(P)', results.base.penetration * 100, results.target.penetration * 100, v => `${v.toFixed(2)}%`)}
                        ${createSummaryCard('購入者数', results.base.buyers, results.target.buyers, v => Math.round(v).toLocaleString() + '人')}
                        ${createSummaryCard('総購入回数', results.base.totalPurchases, results.target.totalPurchases, v => Math.round(v).toLocaleString() + '回')}
                    </div>
                    
                    <div class="space-y-4 pt-6 border-t">
                        <h4 class="font-bold text-lg text-gray-800">利益インパクト</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="p-4 bg-gray-100 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <p class="text-sm font-medium text-gray-600">${periodText}の現状粗利</p>
                                    <div class="tooltip-container">
                                        <i data-lucide="help-circle" class="text-gray-400" style="width: 16px; height: 16px;"></i>
                                        <div class="tooltip-content"><b>計算式:</b><br>総購入回数 × 1購入あたりの平均利益</div>
                                    </div>
                                </div>
                                <p class="text-xl font-bold text-gray-800">${Math.round(baseProfit).toLocaleString()}円</p>
                            </div>
                            <div class="p-4 bg-green-100 rounded-lg">
                               <div class="flex items-center justify-between">
                                    <p class="text-sm font-medium text-green-800">${periodText}の目標粗利</p>
                                    <div class="tooltip-container">
                                        <i data-lucide="help-circle" class="text-green-400" style="width: 16px; height: 16px;"></i>
                                        <div class="tooltip-content"><b>計算式:</b><br>予測総購入回数 × 1購入あたりの平均利益</div>
                                    </div>
                                </div>
                                <p class="text-xl font-bold text-green-800">${Math.round(targetProfit).toLocaleString()}円</p>
                            </div>
                            <div class="p-4 bg-blue-100 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <p class="text-sm font-medium text-blue-800">粗利の変化</p>
                                    <div class="tooltip-container">
                                        <i data-lucide="help-circle" class="text-blue-400" style="width: 16px; height: 16px;"></i>
                                        <div class="tooltip-content"><b>計算式:</b><br>目標粗利 - 現状粗利</div>
                                    </div>
                                </div>
                                <p class="text-xl font-bold ${profitChange >= 0 ? 'text-blue-800' : 'text-red-600'}">${profitChange >= 0 ? '+' : ''}${Math.round(profitChange).toLocaleString()}円</p>
                            </div>
                             <div class="p-4 bg-indigo-100 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <p class="text-sm font-medium text-indigo-800">マーケティングROI</p>
                                    <div class="tooltip-container">
                                        <i data-lucide="help-circle" class="text-indigo-400" style="width: 16px; height: 16px;"></i>
                                        <div class="tooltip-content"><b>計算式:</b><br>(粗利の変化 ÷ 予算) × 100</div>
                                    </div>
                                </div>
                                <p class="text-xl font-bold text-indigo-800">${isFinite(roi) ? `${roi.toFixed(1)}%` : '∞'}</p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8">
                        <h3 class="text-xl font-semibold mb-4 border-b pb-3 flex items-center"><i data-lucide="bot" class="h-6 w-6 mr-2 text-indigo-500"></i> AIコンサルタントの戦略レポート</h3>
                        <div id="sim-ai-report" class="prose"></div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        };
        
        simRunButton.addEventListener('click', () => {
            const res = runSimulation();
            if(!res){
                simResultsContainer.innerHTML = `<p class="text-red-500 flex items-center justify-center h-full min-h-[400px]">エラーが発生しました。入力値を確認してください。</p>`;
                simAiButton.disabled = true;
                return;
            }
            appState.simulation.results = res;
            simAiButton.disabled = !res;
            renderSimulationResults();
        });

        simAiButton.addEventListener('click', () => {
            const { results, period } = appState.simulation;
            if (!results) return;
            
            const avgProfit = Number(simAvgProfitInput.value) || 0;
            const budget = Number(simBudgetInput.value) || 0;
            const baseProfit = results.base.totalPurchases * avgProfit;
            const targetProfit = results.target.totalPurchases * avgProfit;
            const profitChange = targetProfit - baseProfit;

            const prompt = `あなたは、データに基づいた提案を得意とする経営コンサルタントです。クライアント（広告会社の営業担当者）が、その先の顧客に提案するための、分かりやすく実行可能な戦略レポートを作成してください。

# クライアントの基本情報
- 業種: ${simAiIndustry.value || '指定なし'}
- ターゲット顧客: ${simAiTarget.value || '指定なし'}
- 自社の強み: ${simAiStrengths.value || '指定なし'}

# シミュレーションのサマリー
- 分析期間: ${period === 'annual' ? '年間' : '月間'}
- 現状の購入者数: ${Math.round(results.base.buyers).toLocaleString()}人 → 目標: ${Math.round(results.target.buyers).toLocaleString()}人
- 現状の総購入回数: ${Math.round(results.base.totalPurchases).toLocaleString()}回 → 目標: ${Math.round(results.target.totalPurchases).toLocaleString()}回
- 達成による粗利の変化: +${profitChange.toLocaleString()}円 (マーケティング予算: ${budget.toLocaleString()}円)
- その他の前提条件・制約: ${simAiContext.value || '特記事項なし'}

# 指示
上記の情報を総合的に判断し、以下の三部構成で、提案書としてそのまま使えるレベルの戦略レポートを生成してください。余計な挨拶や締め言葉は一切不要です。

### Part 1: 現状の診断サマリー
シミュレーション結果が示す目標達成のインパクト（特に利益への貢献）を簡潔に説明してください。その上で、この目標を達成するための中心的な課題（例：新規顧客をXX人増やすには、認知度が課題）を特定してください。

### Part 2: 具体的なアクションプラン
「クライアントの強み」を活かし、課題を解決するための具体的なアクションプランを提案してください。単なる施策の羅列ではなく、「誰に」「何を」「どのように」伝えるかまで踏み込んで記述してください。

### Part 3: 成功を測るための主要KPI
提案したアクションプランが成功しているかを判断するための、具体的な数値目標（KPI）を2〜3個設定してください。例：「Webサイトからの問い合わせ件数：月20件 → 月40件」のように、現状と目標が比較できるように示してください。`;
            
            const reportElement = document.getElementById('sim-ai-report');
            callGeminiAPI(prompt, reportElement, simAiButton);
        });
        
        // --- Time Series Analysis ---
        const timeSeriesDataContainer = document.getElementById('timeseries-data-container');
        const timeSeriesResultsTable = document.getElementById('timeseries-results-table');
        const timeSeriesAddPeriodButton = document.getElementById('timeseries-add-period-button');
        const timeSeriesAiButton = document.getElementById('timeseries-ai-button');
        const chartContainer = document.getElementById('timeseries-chart-container');
        const chartLegendContainer = document.getElementById('timeseries-chart-legend');
        const tooltip = document.getElementById('chart-tooltip');
        
        const timeseriesAiIndustry = document.getElementById('timeseries-ai-industry');
        const timeseriesAiTarget = document.getElementById('timeseries-ai-target');
        const timeseriesAiContext = document.getElementById('timeseries-ai-context');

        timeseriesAiIndustry.addEventListener('input', (e) => appState.timeSeries.aiContext.industry = e.target.value);
        timeseriesAiTarget.addEventListener('input', (e) => appState.timeSeries.aiContext.target = e.target.value);
        timeseriesAiContext.addEventListener('input', (e) => appState.timeSeries.aiContext.context = e.target.value);

        const renderTimeSeriesChart = (analysisData) => {
            chartContainer.innerHTML = '';
            chartLegendContainer.innerHTML = '';
            if (analysisData.length < 1) {
                chartContainer.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">データを入力してください。</div>';
                return;
            }

            const isTwoPointData = analysisData.length === 2;
            const offsets = [0, 2, -2]; 

            const metrics = {
                m_score:     { color: '#8b5cf6', name: 'プレファレンススコア', formatter: v => v.toFixed(0) },
                penetration: { color: '#3b82f6', name: '浸透率', formatter: v => `${v.toFixed(2)}%` },
                frequency:   { color: '#10b981', name: '平均購入回数', formatter: v => `${v.toFixed(2)}回` }
            };

            const margin = { top: 20, right: 20, bottom: 30, left: 50 };
            const width = chartContainer.clientWidth;
            const height = chartContainer.clientHeight;
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', '100%');
            svg.setAttribute('height', '100%');
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
            chartContainer.appendChild(svg);

            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.setAttribute('transform', `translate(${margin.left},${margin.top})`);
            svg.appendChild(g);
            
            const xAxis = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            const xStep = analysisData.length > 1 ? chartWidth / (analysisData.length - 1) : chartWidth / 2;
            analysisData.forEach((d, i) => {
                const x = i * xStep;
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', x);
                text.setAttribute('y', chartHeight + 20);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('font-size', '10px');
                text.textContent = d.period;
                xAxis.appendChild(text);
            });
            g.appendChild(xAxis);

            const yAxis = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            for(let i=0; i <= 4; i++) {
                const y = chartHeight * (i/4);
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', 0); line.setAttribute('y1', y);
                line.setAttribute('x2', chartWidth); line.setAttribute('y2', y);
                line.setAttribute('stroke', '#e5e7eb');
                yAxis.appendChild(line);

                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', -10); text.setAttribute('y', y + 3);
                text.setAttribute('text-anchor', 'end');
                text.setAttribute('font-size', '10px');
                text.textContent = `${100 - i*25}`;
                yAxis.appendChild(text);
            }
            g.appendChild(yAxis);
            
            const normalizedData = {};
            Object.keys(metrics).forEach(key => {
                const values = analysisData.map(d => d[key]);
                const min = Math.min(...values);
                const max = Math.max(...values);
                normalizedData[key] = { min, max, range: max - min };
            });

            Object.entries(metrics).forEach(([key, { color }], metricIndex) => {
                const { min, range } = normalizedData[key];
                
                if (analysisData.length > 1) {
                    let pathD = 'M';
                    analysisData.forEach((d, i) => {
                        const x = i * xStep;
                        let y = range > 0 ? chartHeight - ((d[key] - min) / range) * chartHeight : chartHeight / 2;
                        if (isTwoPointData) y += offsets[metricIndex] || 0;
                        pathD += `${i === 0 ? '' : 'L '}${x},${y} `;
                    });
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path.setAttribute('d', pathD);
                    path.setAttribute('fill', 'none'); path.setAttribute('stroke', color); path.setAttribute('stroke-width', '2');
                    g.appendChild(path);
                }

                analysisData.forEach((d, i) => {
                    const x = i * xStep;
                    let y = range > 0 ? chartHeight - ((d[key] - min) / range) * chartHeight : chartHeight / 2;
                    if (isTwoPointData) y += offsets[metricIndex] || 0;
                    
                    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('cx', x); circle.setAttribute('cy', y); circle.setAttribute('r', 5);
                    circle.setAttribute('fill', color); circle.setAttribute('stroke', 'white'); circle.setAttribute('stroke-width', '2');
                    circle.style.cursor = 'pointer';
                    
                    circle.addEventListener('mouseenter', (e) => {
                        circle.setAttribute('r', '7');
                        tooltip.style.display = 'block';
                        let tooltipText = `【${d.period}】\n` + 
                            Object.entries(metrics).map(([mKey, mVal]) => 
                                `${mVal.name}: ${mVal.formatter(d[mKey])}`
                            ).join('\n');
                        if(d.events) tooltipText += `\n\n施策: ${d.events}`;
                        tooltip.textContent = tooltipText;
                        
                        const chartRect = chartContainer.getBoundingClientRect();
                        const tooltipRect = tooltip.getBoundingClientRect();
                        let left = e.clientX - chartRect.left + 15;
                        let top = e.clientY - chartRect.top + 15;
                        if (left + tooltipRect.width > chartRect.width) left = e.clientX - chartRect.left - tooltipRect.width - 15;
                        if (top + tooltipRect.height > chartRect.height) top = e.clientY - chartRect.top - tooltipRect.height - 15;
                        tooltip.style.left = `${left}px`;
                        tooltip.style.top = `${top}px`;
                    });
                    circle.addEventListener('mouseleave', () => { 
                        circle.setAttribute('r', '5');
                        tooltip.style.display = 'none'; 
                    });
                    g.appendChild(circle);
                    
                    if (d.events) {
                        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        line.setAttribute('x1', x); line.setAttribute('y1', y); line.setAttribute('x2', x); line.setAttribute('y2', chartHeight);
                        line.setAttribute('stroke', '#9ca3af'); line.setAttribute('stroke-dasharray', '2,2');
                        g.appendChild(line);
                    }
                });
            });
            
            Object.values(metrics).forEach(({ color, name }) => {
                const legendItem = document.createElement('div');
                legendItem.className = 'flex items-center text-xs';
                legendItem.innerHTML = `<span class="w-3 h-3 rounded-full mr-2" style="background-color: ${color};"></span><span>${name}</span>`;
                chartLegendContainer.appendChild(legendItem);
            });
        };

        const renderTimeSeries = () => {
            timeSeriesDataContainer.innerHTML = '';
            appState.timeSeries.data.forEach((d, index) => {
                const periodEl = document.createElement('div');
                periodEl.className = 'p-3 border rounded-lg bg-gray-50';
                const uniqueId = d.id || `${Date.now()}-${index}`;
                d.id = uniqueId;
                periodEl.innerHTML = `
                    <button data-id="${uniqueId}" class="float-right text-gray-400 hover:text-red-500 ts-remove-btn"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    <div class="mb-2"><label class="text-sm font-medium">期間</label><input type="text" value="${d.period}" data-id="${uniqueId}" data-field="period" class="w-full p-2 border border-gray-300 rounded-lg mt-1 ts-input"/></div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="text-sm font-medium">購入者数</label><input type="number" value="${d.buyers}" data-id="${uniqueId}" data-field="buyers" class="w-full p-2 border border-gray-300 rounded-lg mt-1 ts-input"/></div>
                        <div><label class="text-sm font-medium">総購入回数</label><input type="number" value="${d.purchases}" data-id="${uniqueId}" data-field="purchases" class="w-full p-2 border border-gray-300 rounded-lg mt-1 ts-input"/></div>
                    </div>
                    <div class="mt-2"><label class="text-sm font-medium">主な出来事・施策</label><textarea rows="2" data-id="${uniqueId}" data-field="events" class="w-full p-2 border border-gray-300 rounded-lg mt-1 ts-input" placeholder="例: 新規キャンペーン実施...">${d.events}</textarea></div>
                `;
                timeSeriesDataContainer.appendChild(periodEl);
            });
            lucide.createIcons();
            renderTimeSeriesResults();
        };

        const renderTimeSeriesResults = () => {
            const { totalCustomers } = appState.commonInputs;
            timeSeriesResultsTable.innerHTML = '';
            const analysisData = [...appState.timeSeries.data]
                .map(d => ({
                    ...d,
                    m_score: (totalCustomers > 0 && d.purchases > 0) ? (d.purchases / totalCustomers) * 1000 : 0,
                    penetration: (totalCustomers > 0 && d.buyers > 0) ? (d.buyers / totalCustomers) * 100 : 0,
                    frequency: d.buyers > 0 ? d.purchases / d.buyers : 0,
                }));

            analysisData.forEach(d => {
                const row = document.createElement('tr');
                row.className = 'border-b';
                row.innerHTML = `
                    <td class="p-2 font-semibold">${d.period}</td>
                    <td class="p-2 font-bold">${d.m_score.toFixed(0)}</td>
                    <td class="p-2">${d.penetration.toFixed(2)}</td>
                    <td class="p-2">${d.frequency.toFixed(2)}</td>
                    <td class="p-2 text-xs">${d.events}</td>
                `;
                timeSeriesResultsTable.appendChild(row);
            });
            renderTimeSeriesChart(analysisData);
        };

        timeSeriesDataContainer.addEventListener('input', (e) => {
            if (e.target.classList.contains('ts-input')) {
                const { id, field } = e.target.dataset;
                const value = e.target.type === 'number' ? Number(e.target.value) : e.target.value;
                const data = appState.timeSeries.data.find(d => String(d.id) === String(id));
                if (data) data[field] = value;
                appState.activeCaseKey = null;
                renderTimeSeriesResults();
            }
        });

        timeSeriesDataContainer.addEventListener('click', (e) => {
            const removeButton = e.target.closest('.ts-remove-btn');
            if (removeButton) {
                appState.timeSeries.data = appState.timeSeries.data.filter(d => String(d.id) !== removeButton.dataset.id);
                renderTimeSeries();
            }
        });

        timeSeriesAddPeriodButton.addEventListener('click', () => {
            const newId = Date.now();
            appState.timeSeries.data.push({ id: newId, period: '新規期間', buyers: 0, purchases: 0, events: '' });
            renderTimeSeries();
        });

        timeSeriesAiButton.addEventListener('click', () => {
            const { totalCustomers } = appState.commonInputs;
            const { aiContext } = appState.timeSeries;
            const trendDetails = [...appState.timeSeries.data]
                .map(d => `- 期間: ${d.period}\\n  - プレファレンススコア: ${((totalCustomers > 0 ? d.purchases / totalCustomers : 0) * 1000).toFixed(0)}\\n  - 浸透率: ${ (totalCustomers > 0 ? (d.buyers / totalCustomers) * 100 : 0).toFixed(2)}%\\n  - 平均購入回数: ${(d.buyers > 0 ? d.purchases / d.buyers : 0).toFixed(2)}\\n  - 主な出来事/施策: ${d.events || '特記事項なし'}`).join('\\n');

            const prompt = `あなたは、データに基づいた提案を得意とする経営コンサルタントです。クライアント（広告会社の営業担当者）が、その先の顧客に提案するための、分かりやすく実行可能な戦略レポートを作成してください。

# クライアントの基本情報
- 業種: ${aiContext.industry || '指定なし'}
- ターゲット顧客: ${aiContext.target || '指定なし'}
- 市場全体の動向や内部的な課題: ${aiContext.context || '特記事項なし'}

# 分析データ
${trendDetails}

# 指示
上記の情報を総合的に分析し、以下の三部構成で、提案書としてそのまま使えるレベルの戦略レポートを生成してください。余計な挨拶や締め言葉、マークダウンのテーブル記法(|---|)は一切不要です。

### Part 1: 現状の診断サマリー
全体のトレンド（特にプレファレンススコアの推移）を要約してください。「いつ、どの指標が、どのように変化したか」を明確に指摘し、ビジネスが成長しているのか、停滞しているのかを診断してください。

### Part 2: 具体的なアクションプラン
各期間の「出来事・施策」と「指標の変化」を関連付けてパフォーマンスが変動した要因を深く推察し、今後さらにプレファレンスを向上させるための具体的なアクションプランを提案してください。

### Part 3: 成功を測るための主要KPI
提案したアクションプランが成功しているかを判断するための、具体的な数値目標（KPI）を2〜3個設定してください。例：「Webサイトからの問い合わせ件数：月20件 → 月40件」のように、現状と目標が比較できるように示してください。`;

            const reportElement = document.getElementById('timeseries-ai-report');
            callGeminiAPI(prompt, reportElement, timeSeriesAiButton);
        });

        // --- Initialization ---
        const loadCaseStudy = (exampleKey) => {
            const data = appState.caseStudies.find(c => c.key === exampleKey);
            if (!data) return;
            
            appState.activeCaseKey = exampleKey;

            totalCustomersInput.value = data.totalCustomers;
            kValueInput.value = data.kValue;
            kValueDisplay.textContent = data.kValue.toFixed(2);
            appState.commonInputs.totalCustomers = data.totalCustomers;
            appState.commonInputs.kValue = data.kValue;
            
            if (data.aiContext) {
                singleAiIndustry.value = data.aiContext.industry || '';
                singleAiProducts.value = data.aiContext.products || '';
                singleAiTarget.value = data.aiContext.target || '';
                singleAiStrengths.value = data.aiContext.strengths || '';
                simAiIndustry.value = data.aiContext.industry || '';
                simAiTarget.value = data.aiContext.target || '';
                simAiStrengths.value = data.aiContext.strengths || '';
                simAiContext.value = data.aiContext.simContext || '';
                timeseriesAiIndustry.value = data.aiContext.industry || '';
                timeseriesAiTarget.value = data.aiContext.target || '';
            }
            
            if (data.timeSeriesData) {
                appState.timeSeries.data = data.timeSeriesData.map((d, index) => ({ ...d, id: Date.now() + index }));
            }

            handleSinglePeriodChange(appState.singleBrand.period);
            handleSimPeriodChange(appState.simulation.period);
            renderTimeSeries();

            switchTab('single');
            singleAnalyzeButton.click();
        };

        const initializeGuidesAndCases = () => {
            const guidesContainer = document.getElementById('industry-guides-container');
            appState.industryGuides.forEach(guide => {
                const guideEl = document.createElement('div');
                guideEl.className = 'bg-white border rounded-lg shadow-sm mb-6';
                const tableRows = guide.data.map(item => `
                    <tr class="border-b last:border-none">
                        <td class="py-3 pr-2 align-top font-bold text-gray-700">${item.metric}</td>
                        <td class="py-3 align-top"><ul class="list-disc list-inside space-y-2 text-gray-600">${item.examples.map(ex => `<li>${ex}</li>`).join('')}</ul></td>
                    </tr>
                `).join('');
                guideEl.innerHTML = `
                    <h4 class="font-bold text-lg text-gray-800 mb-0 p-4 bg-gray-50 rounded-t-lg">🏢 ${guide.title}</h4>
                    <div class="p-4">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b">
                                    <th class="text-left font-semibold text-gray-600 py-2 pr-2 w-1/4">基本データ</th>
                                    <th class="text-left font-semibold text-gray-600 py-2">考え方の切り口・データソースの例</th>
                                </tr>
                            </thead>
                            <tbody>${tableRows}</tbody>
                        </table>
                    </div>`;
                guidesContainer.appendChild(guideEl);
            });

            const casesContainer = document.getElementById('case-studies-container');
            appState.caseStudies.forEach(study => {
                const caseEl = document.createElement('div');
                caseEl.className = 'p-4 border rounded-lg shadow-sm bg-white';
                caseEl.innerHTML = `
                    <h4 class="font-bold text-gray-800 text-lg mb-2">${study.title}</h4>
                    <p class="text-sm text-gray-600 mb-4">${study.description}</p>
                    <button data-key="${study.key}" class="case-study-button w-full mb-2 bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition flex items-center justify-center shadow">
                        <i data-lucide="send" class="h-5 w-5 mr-2"></i> このデータで分析する
                    </button>`;
                casesContainer.appendChild(caseEl);
            });

            document.querySelectorAll('.case-study-button').forEach(button => {
                button.addEventListener('click', () => loadCaseStudy(button.dataset.key));
            });
        };
        
        // --- Execute Initialization ---
        lucide.createIcons();
        initializeGuidesAndCases();
        if(appState.timeSeries.data.length === 0){
            appState.timeSeries.data = [
                { id: 1, period: '2024-Q1', buyers: 800, purchases: 2200, events: '新規オープン' },
                { id: 2, period: '2024-Q2', buyers: 850, purchases: 2400, events: 'Web広告開始' },
            ];
        }
        renderTimeSeries();
    } // End of initializeAppLogic

    // Initial check to start the app
    updateAuthUI('LOADING');
    supabaseClient.auth.getSession().then(({ data: { session } }) => {
        if (session) {
            updateAuthUI('APP');
        } else {
            updateAuthUI('LOGIN');
        }
    });
});
</script>
</body>
</html>
